<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Interview Chat</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      max-width: 700px; 
      margin: 2em auto; 
      padding: 0 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 20px;
      margin: 20px 0;
    }
    
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2em;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    #chat { 
      border: 2px solid #e1e8ed; 
      height: 450px; 
      overflow-y: auto; 
      padding: 20px; 
      background: linear-gradient(to bottom, #f8fafc, #ffffff);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .message { 
      margin: 15px 0; 
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user { 
      text-align: right; 
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    
    .ai { 
      text-align: left; 
      background: #f1f5f9;
      color: #334155;
      margin-right: auto;
      border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
    }
    
    .timer-msg { 
      text-align: center; 
      color: #dc3545; 
      font-weight: bold; 
      background: linear-gradient(135deg, #ffe6e6, #fff0f0);
      padding: 15px; 
      border-radius: 10px; 
      border: 2px solid #fecaca;
      margin: 20px auto;
      max-width: 90%;
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.1);
    }
    
    #inputArea { 
      margin-top: 15px; 
      display: flex; 
      gap: 10px;
      align-items: flex-end;
    }
    
    #input { 
      flex: 1; 
      padding: 15px; 
      font-size: 1em; 
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      outline: none;
      transition: all 0.3s ease;
      resize: vertical;
      min-height: 50px;
      max-height: 120px;
      font-family: inherit;
    }
    
    #input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    #sendBtn { 
      padding: 15px 25px; 
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      min-width: 80px;
    }
    
    #sendBtn:hover:not(.disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }
    
    .btn-level {
      margin: 8px;
      padding: 12px 20px;
      font-size: 1em;
      border: 2px solid #667eea;
      border-radius: 25px;
      cursor: pointer;
      background: white;
      color: #667eea;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-level:hover {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #dc3545, #e74c3c);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      font-weight: bold;
      display: none;
      box-shadow: 0 8px 16px rgba(220, 53, 69, 0.3);
      z-index: 1000;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .disabled { 
      background: #9ca3af !important; 
      cursor: not-allowed !important; 
      transform: none !important;
      box-shadow: none !important;
    }
    
    .status-indicator {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.9em;
      font-weight: 600;
      display: none;
    }
    
    .status-active {
      background: #10b981;
      color: white;
    }
    
    .status-ended {
      background: #6b7280;
      color: white;
    }
    
    .question-counter {
      text-align: center;
      color: #6b7280;
      font-size: 0.9em;
      margin: 10px 0;
      padding: 8px;
      background: #f8fafc;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<div class="timer" id="timer">Time: 3:00</div>
<div class="status-indicator" id="status">Interview Active</div>

<div class="container">
  <h2>üéØ Interview IQ Hub</h2>
  <div class="question-counter" id="questionCounter" style="display: none;">
    Question <span id="currentQuestion">1</span> of <span id="totalQuestions">~8-10</span>
  </div>
  <div id="chat"></div>

  <div id="inputArea">
    <textarea id="input" placeholder="Type your answer here... (Press Shift+Enter for new line, Enter to send)" autocomplete="off" rows="2"></textarea>
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
  const chat = document.getElementById('chat');
  let input = document.getElementById('input');
  let sendBtn = document.getElementById('sendBtn');
  const inputArea = document.getElementById('inputArea');
  const questionCounter = document.getElementById('questionCounter');
  const currentQuestionSpan = document.getElementById('currentQuestion');
  const statusIndicator = document.getElementById('status');

  let step = 0;
  let name = '';
  let email = '';
  let skill = '';
  let level = '';
  let interviewStartTime = null;
  let interviewTimer = null;
  let interviewEnded = false;
  let timerStarted = false;
  
  // Enhanced session tracking
  let sessionId = 'session-' + Date.now() + '-' + Math.floor(Math.random() * 100000);
  let questionIndex = 0;
  let topicIndex = 0;
  let currentTopic = '';
  let questionsInCurrentTopic = 0;
  let maxQuestionsPerTopic = 3;

  // Interview progress tracking
  let interviewStarted = false;
  let totalQuestionsAsked = 0;
  let correctAnswers = 0;
  let topics = [];

  function addMessage(text, sender, isTimer = false) {
    const div = document.createElement('div');
    div.className = 'message ' + sender + (isTimer ? ' timer-msg' : '');
    
    // Handle multi-line text properly
    if (isTimer) {
      div.textContent = text;
    } else {
      div.innerHTML = text.replace(/\n/g, '<br>');
    }
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function updateQuestionCounter() {
    if (interviewStarted && questionIndex > 0) {
      questionCounter.style.display = 'block';
      currentQuestionSpan.textContent = questionIndex;
    }
  }

  function updateStatus(status) {
    statusIndicator.textContent = status;
    statusIndicator.style.display = 'block';
    if (status.includes('Ended')) {
      statusIndicator.className = 'status-indicator status-ended';
    } else {
      statusIndicator.className = 'status-indicator status-active';
    }
  }

  function disableInput() {
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = "Interview Ended";
    sendBtn.classList.add('disabled');
    input.classList.add('disabled');
    input.placeholder = "Interview has ended - Thank you for participating!";
    updateStatus('Interview Ended');
  }

  function startInterviewTimer() {
    if (timerStarted) return;
    
    timerStarted = true;
    interviewStarted = true;
    interviewStartTime = Date.now();
    
    updateStatus('Interview Active');
    updateQuestionCounter();
    
    addMessage("‚è∞ Let's start your technical interview! You have 3 minutes to demonstrate your expertise.", "ai", true);
    addMessage("üöÄ Your time starts now - Good luck!", "ai", true);
    
    const timerElement = document.getElementById('timer');
    timerElement.style.display = 'block';
    
    // Update timer display every second
    const timerInterval = setInterval(() => {
      const remaining = getRemainingTime();
      const minutes = Math.floor(remaining / 60);
      const seconds = remaining % 60;
      timerElement.textContent = `Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Warning at 30 seconds
      if (remaining === 30) {
        addMessage("‚ö†Ô∏è 30 seconds remaining! Wrap up your current answer.", "ai", true);
        timerElement.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
      }
      
      if (remaining <= 0) {
        clearInterval(timerInterval);
        timerElement.textContent = 'Time: 0:00';
      }
    }, 1000);
    
    interviewTimer = setTimeout(() => {
      clearInterval(timerInterval);
      interviewEnded = true;
      addMessage("‚è∞ Time's up! Interview completed. Thank you for participating!", "ai", true);
      addMessage(`üìä Interview Summary: ${totalQuestionsAsked} questions asked across ${topics.length} topics.`, "ai");
      disableInput();
      timerElement.style.background = '#6b7280';
      
      sendCompletionStatus();
    }, 180000); // 3 minutes
  }

  async function sendCompletionStatus() {
    try {
      const webhookUrl = 'https://interviewainumpy.app.n8n.cloud/webhook/virtual-interview';
      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          sessionId: sessionId,
          name: name,
          email: email, 
          skill: skill,
          level: level,
          userMessage: "INTERVIEW_COMPLETED",
          questionIndex: questionIndex,
          topicIndex: topicIndex,
          step: 'completed',
          totalQuestions: totalQuestionsAsked,
          topics: topics.join(', ')
        }),
      });
      
      if (!response.ok) {
        console.error('Failed to send completion status');
      }
    } catch (err) {
      console.error('Error sending completion status:', err);
    }
  }

  function getRemainingTime() {
    if (!interviewStartTime) return 180;
    const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
    return Math.max(0, 180 - elapsed);
  }

  function checkTimeRemaining() {
    const remaining = getRemainingTime();
    if (remaining <= 0 || interviewEnded) {
      if (!interviewEnded) {
        clearTimeout(interviewTimer);
        interviewEnded = true;
        addMessage("‚è∞ Time's up! Interview completed.", "ai", true);
        disableInput();
      }
      return false;
    }
    return true;
  }

  function isValidEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
    return regex.test(email);
  }

  function isValidSkill(skill) {
    // Allow any skill with basic validation
    const trimmedSkill = skill.trim().toLowerCase();
    
    // Basic validation: must contain letters and be reasonable length
    const hasLetters = /[a-zA-Z]/.test(trimmedSkill);
    const isReasonableLength = trimmedSkill.length >= 2 && trimmedSkill.length <= 50;
    const isNotJustNumbers = !/^\d+$/.test(trimmedSkill);
    const isNotJustSpecialChars = !/^[^a-zA-Z0-9]+$/.test(trimmedSkill);
    
    return hasLetters && isReasonableLength && isNotJustNumbers && isNotJustSpecialChars;
  }

  async function sendMessage() {
    const message = input.value.trim();
    if (!message) return;

    if (interviewEnded) {
      addMessage("Interview has already ended. Thank you for participating!", "ai");
      return;
    }

    if (step === 4 && !checkTimeRemaining()) {
      return;
    }

    addMessage(message, 'user');
    input.value = '';
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = 'Processing...';

    if (step === 0) {
      name = message;
      step++;
      setTimeout(() => {
        addMessage(`Nice to meet you, ${name}! üëã Now please enter your *Email ID*.`, "ai");
        enableInput();
      }, 500);
    } else if (step === 1) {
      if (!isValidEmail(message)) {
        addMessage("‚ö†Ô∏è That doesn't look like a valid email. Please enter a valid one like `yourname@email.com`.", "ai");
        enableInput();
        return;
      }
      email = message;
      step++;
      setTimeout(() => {
        addMessage("Perfect! ‚ú® Now tell me the *Skill* you want to be interviewed on (e.g., any programming language, technology, framework, methodology, or technical domain).", "ai");
        enableInput();
      }, 500);
    } else if (step === 2) {
      skill = message.trim();
      if (skill.length < 2 || !isValidSkill(skill)) {
        addMessage("‚ùå Please enter a valid technical skill. This can be any programming language, technology, framework, tool, or methodology you'd like to be assessed on.", "ai");
        enableInput();
        return;
      }
      step++;
      setTimeout(() => {
        addMessage(`Excellent choice! üéØ You selected *${skill}*. Now please choose your experience level:`, "ai");
        showLevelOptions();
      }, 500);
      return;
    } else if (step === 4) {
      if (interviewEnded) {
        enableInput();
        return;
      }

      try {
        totalQuestionsAsked++;
        updateQuestionCounter();

        const webhookUrl = 'https://interviewainumpy.app.n8n.cloud/webhook/virtual-interview';
        const requestBody = { 
          sessionId: sessionId,
          name: name,
          email: email, 
          skill: skill,
          level: level,
          userMessage: message,
          questionIndex: questionIndex,
          topicIndex: topicIndex,
          step: interviewEnded ? 'completed' : 'ongoing_interview',
          questionsInCurrentTopic: questionsInCurrentTopic,
          currentTopic: currentTopic
        };

        console.log('Sending request:', requestBody);

        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody),
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Get response as text first to debug
        const responseText = await response.text();
        console.log('Raw response:', responseText);

        if (!responseText.trim()) {
          throw new Error('Empty response from server');
        }

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          throw new Error('Invalid JSON response from server');
        }

        console.log("üß™ Webhook Response:", data); 
        
        let aiReply = 'ü§ñ Processing your response...';
        
        if (data && typeof data === 'object') {
          const findReply = (obj) => {
            if (typeof obj === 'string' && obj.length > 5) return obj;
            if (obj && obj.reply && typeof obj.reply === 'string') return obj.reply;
            if (obj && typeof obj === 'object') {
              for (const key in obj) {
                const result = findReply(obj[key]);
                if (result && typeof result === 'string' && result.length > 10) {
                  return result;
                }
              }
            }
            return null;
          };
          
          const foundReply = findReply(data);
          if (foundReply) {
            aiReply = foundReply;
          } else {
            aiReply = "I'm processing your answer. Let me ask you another question to continue.";
          }
        }
        
        if (!interviewEnded) {
          setTimeout(() => {
            addMessage(aiReply, 'ai');
            questionIndex++;
            updateQuestionCounter();
          }, 800);
        }

      } catch (err) {
        console.error('Request error:', err);
        if (!interviewEnded) {
          addMessage('‚ö†Ô∏è Connection issue. Let me ask you another question to continue the interview.', 'ai');
          
          // Universal fallback questions for any skill
          const fallbackQuestions = {
            default: [
              `What are the key concepts or principles in ${skill}?`,
              `How would you explain ${skill} to someone new to it?`,
              `What are some common tools or methodologies used in ${skill}?`,
              `Can you describe a practical application of ${skill}?`,
              `What challenges have you faced while working with ${skill}?`
            ]
          };
          
          const fallbackList = fallbackQuestions.default;
          const randomQuestion = fallbackList[Math.floor(Math.random() * fallbackList.length)];
          
          setTimeout(() => {
            addMessage(randomQuestion, 'ai');
            questionIndex++;
            updateQuestionCounter();
          }, 1000);
        }
      }
    }

    enableInput();
  }

  function enableInput() {
    if (!interviewEnded) {
      input.disabled = false;
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
      input.focus();
    }
  }

  function showLevelOptions() {
    inputArea.innerHTML = `
      <div style="display: flex; flex-wrap: wrap; justify-content: center; width: 100%;">
        <button class="btn-level" onclick="selectLevel('Beginner')">üå± Beginner (0-2 years)</button>
        <button class="btn-level" onclick="selectLevel('Intermediate')">üöÄ Intermediate (2-5 years)</button>
        <button class="btn-level" onclick="selectLevel('Advanced')">‚≠ê Advanced (5+ years)</button>
      </div>
    `;
  }

  async function selectLevel(selected) {
    level = selected;
    step = 4;
    addMessage(selected, 'user');
    addMessage("‚úÖ Perfect! Setting up your personalized interview...", "ai");

    try {
      const webhookUrl = 'https://interviewainumpy.app.n8n.cloud/webhook/virtual-interview';
      const requestBody = { 
        sessionId: sessionId,
        name: name, 
        email: email, 
        skill: skill, 
        level: level,
        userMessage: "",
        questionIndex: 1,
        topicIndex: 0,  
        step: 'start_interview'
      };

      console.log('Level selection request:', requestBody);

      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const responseText = await response.text();
      console.log('Level selection raw response:', responseText);

      if (!responseText.trim()) {
        throw new Error('Empty response from server');
      }

      let data;
      try {
        data = JSON.parse(responseText);
      } catch (parseError) {
        console.error('JSON parse error:', parseError);
        throw new Error('Invalid JSON response from server');
      }

      console.log("üß™ Level Selection Response:", data);
      
      let aiReply = 'üéØ Let\'s begin your technical interview!';
      
      if (data && typeof data === 'object') {
        const findReply = (obj) => {
          if (typeof obj === 'string' && obj.length > 5) return obj;
          if (obj && obj.reply && typeof obj.reply === 'string') return obj.reply;
          if (obj && typeof obj === 'object') {
            for (const key in obj) {
              const result = findReply(obj[key]);
              if (result && typeof result === 'string' && result.length > 10) {
                return result;
              }
            }
          }
          return null;
        };
        
        const foundReply = findReply(data);
        if (foundReply) {
          aiReply = foundReply;
        }
      }
      
      if (!interviewEnded) {
        startInterviewTimer();
        
        setTimeout(() => {
          addMessage(aiReply, 'ai');
          questionIndex = 1;
          updateQuestionCounter();
        }, 1000);
      }

    } catch (err) {
      console.error('Level selection error:', err);
      addMessage('‚ö†Ô∏è Connection issue, but let\'s proceed with your interview!', 'ai');
      
      // Universal fallback first questions for any skill
      const firstQuestions = {
        default: [
          `Let's start with the basics - What are the fundamental concepts of ${skill}?`,
          `Let's begin - How would you define ${skill} and its main purpose?`,
          `Let's start - What makes ${skill} important in today's technology landscape?`,
          `Let's begin - What are the core principles or methodologies in ${skill}?`,
          `Let's start - Can you explain the basic components or elements of ${skill}?`
        ]
      };
      
      const questionList = firstQuestions.default;
      const firstQuestion = questionList[Math.floor(Math.random() * questionList.length)];
      
      startInterviewTimer();
      
      setTimeout(() => {
        addMessage(firstQuestion, 'ai');
        questionIndex = 1;
        updateQuestionCounter();
      }, 1000);
    } finally {
      // Restore input area
      inputArea.innerHTML = `
        <textarea id="input" placeholder="Type your answer here... (Press Shift+Enter for new line, Enter to send)" autocomplete="off" rows="2"></textarea>
        <button id="sendBtn">Send</button>
      `;
      
      // Reattach events
      input = document.getElementById('input');
      sendBtn = document.getElementById('sendBtn');
      
      // Handle textarea enter key properly
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && !interviewEnded) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      sendBtn.onclick = () => {
        if (!interviewEnded) sendMessage();
      };
      
      if (!interviewEnded) input.focus();
    }
  }

  // Initial event listeners
  sendBtn.onclick = () => {
    if (!interviewEnded) sendMessage();
  };
  
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey && !interviewEnded) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Welcome message
  addMessage("Hi there! üëã Welcome to Interview IQ Hub - Your AI Technical Interview Platform.", "ai");
  setTimeout(() => {
    addMessage("I'll be conducting a comprehensive 3-minute technical interview to assess your skills. Let's start with your *Name*.", "ai");
  }, 1000);
</script>

</body>
</html>
