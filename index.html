<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Interview Hub</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input, textarea, button {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    button {
      background: #3498db;
      color: white;
      cursor: pointer;
      border: none;
      font-weight: bold;
    }
    
    button:hover {
      background: #2980b9;
    }
    
    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }
    
    .file-upload {
      border: 2px dashed #ddd;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .file-upload:hover {
      border-color: #3498db;
    }
    
    .file-info {
      margin-top: 10px;
      padding: 10px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
      color: #155724;
      display: none;
    }
    
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
    }
    
    .back-btn {
      width: auto;
      background: #6c757d;
      margin-bottom: 20px;
    }
    
    .back-btn:hover {
      background: #5a6268;
    }
    
    .interview-options {
      display: flex;
      gap: 20px;
      margin: 20px 0;
    }
    
    .option-card {
      flex: 1;
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
    }
    
    .option-card:hover {
      border-color: #3498db;
    }
    
    .option-card.disabled {
      background: #f8f9fa;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .chat-container {
      height: 400px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      overflow-y: auto;
      background: #fafafa;
      margin-bottom: 20px;
    }
    
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      max-width: 80%;
    }
    
    .message.user {
      background: #e3f2fd;
      margin-left: auto;
      text-align: right;
    }
    
    .message.ai {
      background: #f5f5f5;
      margin-right: auto;
    }
    
    .message.timer {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      text-align: center;
      font-weight: bold;
      margin: 10px auto;
      max-width: 90%;
    }
    
    .message.loading {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      text-align: center;
      font-style: italic;
      margin: 10px auto;
      max-width: 90%;
    }
    
    .input-area {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    
    .input-area textarea {
      flex: 1;
      max-height: 80px;
      min-height: 40px;
    }
    
    .input-area button {
      width: 80px;
    }
    
    .timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #e74c3c;
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      font-weight: bold;
      display: none;
    }
    
    .user-info {
      background: #e8f4fd;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .question-counter {
      text-align: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 15px;
      display: none;
    }
    
    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>

<div class="timer" id="timer">Time: 3:00</div>

<div class="container">
  <!-- Resume Upload Section -->
  <div class="section active" id="resumeSection">
    <h2>AI Interview Hub</h2>
    
    <div class="form-group">
      <label>Resume *</label>
      <div class="file-upload" onclick="document.getElementById('resumeFile').click()">
        <p>üìÑ Click to upload your resume</p>
        <p><small>PDF, DOC, DOCX, or TXT files only</small></p>
        <input type="file" id="resumeFile" accept=".pdf,.doc,.docx,.txt" style="display: none;" onchange="handleFileUpload(this)">
      </div>
      <div class="file-info" id="fileInfo"></div>
    </div>
    
    <div class="form-group">
      <label for="jobTitle">Job Title *</label>
      <input type="text" id="jobTitle" placeholder="e.g. Software Engineer, Data Analyst..." required>
    </div>
    
    <div class="form-group">
      <label for="jobDescription">Job Description (Optional)</label>
      <textarea id="jobDescription" placeholder="Paste the job description here..."></textarea>
    </div>
    
    <button onclick="proceedToInterviewType()">Continue</button>
  </div>

  <!-- Interview Type Selection -->
  <div class="section" id="interviewTypeSection">
    <button class="back-btn" onclick="goBack()">‚Üê Back</button>
    <h2>Choose Interview Mode</h2>
    
    <div class="interview-options">
      <div class="option-card" onclick="startChatInterview()">
        <h3>üí¨ Chat Interview</h3>
        <p>Text-based interview with AI</p>
      </div>
      <div class="option-card disabled" onclick="showComingSoon()">
        <h3>üé§ Audio Interview</h3>
        <p>Voice-based interview (Coming Soon)</p>
      </div>
    </div>
  </div>
  
  <!-- Interview Container -->
  <div class="section" id="interviewSection">
    <button class="back-btn" onclick="goBack()">‚Üê Back</button>
    <h2>AI Interview</h2>
    
    <div class="user-info" id="userInfo"></div>
    <div class="question-counter" id="questionCounter">
      Question <span id="currentQuestion">1</span>
    </div>
    
    <div class="chat-container" id="chat"></div>

    <div class="input-area" id="inputArea">
      <textarea id="input" placeholder="Type your answer..." rows="1"></textarea>
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
  // Global variables
  const chat = document.getElementById('chat');
  let input = document.getElementById('input');
  let sendBtn = document.getElementById('sendBtn');

  let resumeFile = null;
  let resumeContent = '';
  let jobTitle = '';
  let jobDescription = '';
  let interviewStartTime = null;
  let interviewEnded = false;
  let timerStarted = false;
  
  let questionIndex = 0;
  let totalQuestionsAsked = 0;
  let conversationHistory = '';

  // Navigation functions
  function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(section => {
      section.classList.remove('active');
    });
    document.getElementById(sectionId).classList.add('active');
  }

  function goBack() {
    const activeSection = document.querySelector('.section.active');
    
    if (activeSection.id === 'interviewSection') {
      showSection('interviewTypeSection');
      resetInterview();
    } else if (activeSection.id === 'interviewTypeSection') {
      showSection('resumeSection');
    }
  }

  // File handling
  function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const validTypes = ['application/pdf', 'application/msword', 
                       'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
                       'text/plain'];
    if (!validTypes.includes(file.type)) {
      alert('Please upload a PDF, DOC, DOCX, or TXT file.');
      input.value = '';
      return;
    }

    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
      alert('File size must be less than 5MB.');
      input.value = '';
      return;
    }

    resumeFile = file;
    const fileInfo = document.getElementById('fileInfo');
    fileInfo.innerHTML = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    fileInfo.style.display = 'block';
  }

  async function fileToText(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(reader.error);
      
      if (file.type === 'text/plain') {
        reader.readAsText(file);
      } else {
        reader.readAsDataURL(file); // For PDF/DOC - you may need server processing
      }
    });
  }

  async function proceedToInterviewType() {
    if (!resumeFile) {
      alert('Please upload your resume first.');
      return;
    }

    const jobTitleValue = document.getElementById('jobTitle').value.trim();
    if (!jobTitleValue) {
      alert('Please enter the job title.');
      return;
    }

    try {
      resumeContent = await fileToText(resumeFile);
      jobTitle = jobTitleValue;
      jobDescription = document.getElementById('jobDescription').value.trim();
      
      showSection('interviewTypeSection');
      
    } catch (error) {
      console.error('Error processing resume:', error);
      alert('Error processing resume file. Please try again.');
    }
  }

  function showComingSoon() {
    alert('Audio Interview feature is coming soon! Please try the Chat Interview for now.');
  }

  function startChatInterview() {
    showSection('interviewSection');
    startResumeBasedInterview();
  }

  // Interview functions
  function addMessage(text, sender, isTimer = false, isLoading = false) {
    const div = document.createElement('div');
    let className = 'message ' + sender;
    if (isTimer) className += ' timer';
    if (isLoading) className += ' loading';
    
    div.className = className;
    div.innerHTML = text.replace(/\n/g, '<br>');
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    
    return div;
  }

  function addDebugMessage(title, data) {
    const div = document.createElement('div');
    div.className = 'debug-info';
    div.innerHTML = `<strong>${title}:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function updateQuestionCounter() {
    if (timerStarted && questionIndex > 0) {
      document.getElementById('questionCounter').style.display = 'block';
      document.getElementById('currentQuestion').textContent = questionIndex;
    }
  }

  function disableInput() {
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = "Ended";
    input.placeholder = "Interview completed";
  }

  function enableInput() {
    if (!interviewEnded) {
      input.disabled = false;
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
    }
  }

  function startInterviewTimer() {
    if (timerStarted) return;
    
    timerStarted = true;
    interviewStartTime = Date.now();
    
    addMessage("‚è±Ô∏è Your 3-minute interview starts now!", "ai", true);
    
    const timerElement = document.getElementById('timer');
    timerElement.style.display = 'block';
    
    const timerInterval = setInterval(() => {
      const remaining = getRemainingTime();
      const minutes = Math.floor(remaining / 60);
      const seconds = remaining % 60;
      timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      if (remaining === 30) {
        addMessage("‚ö†Ô∏è 30 seconds left!", "ai", true);
      }
      
      if (remaining <= 0) {
        clearInterval(timerInterval);
        endInterview();
      }
    }, 1000);
  }

  function endInterview() {
    if (interviewEnded) return;
    
    interviewEnded = true;
    addMessage("‚è∞ Time's up! Interview completed.", "ai", true);
    addMessage(`üìä Questions answered: ${totalQuestionsAsked}`, "ai");
    disableInput();
    
    const timerElement = document.getElementById('timer');
    timerElement.style.background = '#6c757d';
    timerElement.textContent = 'Done';
  }

  function getRemainingTime() {
    if (!interviewStartTime) return 180;
    const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
    return Math.max(0, 180 - elapsed);
  }

  function resetInterview() {
    interviewStartTime = null;
    interviewEnded = false;
    timerStarted = false;
    questionIndex = 0;
    totalQuestionsAsked = 0;
    conversationHistory = '';
    
    chat.innerHTML = '';
    document.getElementById('timer').style.display = 'none';
    document.getElementById('questionCounter').style.display = 'none';
    
    input.disabled = false;
    input.value = '';
    input.placeholder = "Type your answer...";
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
  }

  // AI Integration
  async function callAIInterviewer(userMessage, isFirstMessage = false) {
    console.log('=== CALL AI INTERVIEWER ===');
    console.log('Job title:', jobTitle);
    console.log('Resume content length:', resumeContent ? resumeContent.length : 0);

    const loadingMessage = addMessage("AI is thinking...", "ai", false, true);
    
    let requestBody = {
      body: {
        jobTitle: jobTitle,
        resumeText: resumeContent,
        jobDescription: jobDescription || '',
        conversationHistory: conversationHistory,
        lastQuestion: '',
        answer: userMessage || ''
      }
    };

    if (isFirstMessage) {
      requestBody.body.conversationHistory = '';
      delete requestBody.body.answer;
      delete requestBody.body.lastQuestion;
    }

    console.log('Request body:', requestBody);
    
    try {
      const response = await fetch('https://mathumqa.app.n8n.cloud/webhook/mathu-interview', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      if (chat.contains(loadingMessage)) {
        chat.removeChild(loadingMessage);
      }

      if (response.ok) {
        const data = await response.json();
        console.log('AI Response:', data);
        
       // addDebugMessage('API Response', data);
        
        let aiReply = '';
        let newConversationHistory = '';
        
        if (data && typeof data === 'object') {
          if (data.question && typeof data.question === 'string' && data.question.trim().length > 0) {
            aiReply = data.question.trim();
            newConversationHistory = data.conversationHistory || '';
          } else if (data.reply && typeof data.reply === 'string' && data.reply.trim().length > 0) {
            aiReply = data.reply.trim();
          } else {
            throw new Error('No valid question/reply found in response');
          }
        }
        
        if (aiReply.length > 0) {
          if (newConversationHistory) {
            conversationHistory = newConversationHistory;
          } else {
            if (userMessage && userMessage.trim()) {
              conversationHistory += `User: ${userMessage}\n`;
            }
            conversationHistory += `AI: ${aiReply}\n`;
          }
          
          addMessage(aiReply, 'ai');
          questionIndex++;
          updateQuestionCounter();
          return true;
        } else {
          throw new Error('Empty response from AI service');
        }
      } else {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }
      
    } catch (error) {
      console.error('AI service error:', error);
      
      if (chat.contains(loadingMessage)) {
        chat.removeChild(loadingMessage);
      }
      
      addMessage(`‚ùå Error: ${error.message}`, "ai");
      generateFallbackResponse(userMessage, isFirstMessage);
      return false;
    }
  }

  function generateFallbackResponse(userMessage, isFirstMessage) {
    let response;
    
    if (isFirstMessage) {
      response = `Hello! I've reviewed your resume for the ${jobTitle} position. Can you tell me about your most significant project and the key challenges you overcame?`;
    } else {
      const fallbackQuestions = [
        "Can you explain your approach to problem-solving?",
        "What technologies do you consider essential in your work?",
        "How do you handle working under pressure?",
        "Describe a time you had to learn something new quickly.",
        "What motivates you most in your professional work?"
      ];
      
      const questionIdx = Math.min(totalQuestionsAsked - 1, fallbackQuestions.length - 1);
      response = fallbackQuestions[questionIdx];
    }
    
    if (userMessage && userMessage.trim()) {
      conversationHistory += `User: ${userMessage}\n`;
    }
    conversationHistory += `AI: ${response}\n`;
    
    addMessage(response, 'ai');
    questionIndex++;
    updateQuestionCounter();
  }

  async function sendMessage() {
    const message = input.value.trim();
    if (!message || interviewEnded) return;

    addMessage(message, 'user');
    input.value = '';
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = '...';

    if (getRemainingTime() <= 0) {
      endInterview();
      return;
    }

    totalQuestionsAsked++;
    await callAIInterviewer(message, false);
    enableInput();
  }

  async function startResumeBasedInterview() {
    console.log('=== START INTERVIEW ===');
    
    document.getElementById('userInfo').innerHTML = `Interview for: ${jobTitle}`;
    
    addMessage("I'll conduct an interview based on your resume and the role requirements.", 'ai');
    addMessage("Starting the timer now...", 'ai');
    
    startInterviewTimer();
    await callAIInterviewer("", true);
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', function() {
    sendBtn.addEventListener('click', sendMessage);
    
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 80) + 'px';
    });
  });
</script>

</body>
</html>
