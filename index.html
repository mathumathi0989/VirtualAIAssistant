<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Interview Chat - Enhanced</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #000000 0%, #1A1A2E 50%, #16213E 100%);
      color: white;
      height: 100vh;
      width: 100%;
      max-width: 900px;
      overflow: hidden;
      position: relative;
      margin: 0 auto;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      height: calc(100vh - 20px);
      margin: 10px;
      padding: 25px;
      display: flex;
      flex-direction: column;
    }
    
    h2 {
      text-align: center;
      color: white;
      margin-bottom: 20px;
      font-size: 2.2em;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 15px;
    }
    
    /* Authentication Styles */
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .auth-form {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .auth-form h3 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 1.8em;
      color: white;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 15px;
      font-size: 1.1em;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      outline: none;
      transition: all 0.3s ease;
    }
    
    .form-group input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .form-group input:focus {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .auth-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #ffffff, #e5e5e5);
      color: black;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1em;
      transition: all 0.3s ease;
      margin-bottom: 15px;
    }
    
    .auth-btn:hover {
      background: linear-gradient(135deg, #f0f0f0, #d0d0d0);
      transform: translateY(-1px);
    }
    
    .auth-switch {
      text-align: center;
      margin-top: 20px;
    }
    
    .auth-switch a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    
    .auth-switch a:hover {
      color: white;
    }
    
    .error-msg {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9em;
    }
    
    .success-msg {
      background: rgba(72, 187, 120, 0.2);
      color: #48bb78;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(72, 187, 120, 0.3);
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9em;
    }
    
    /* Interview Chat Styles */
    .interview-container {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    .user-info {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.8);
    }
    
    #chat { 
      border: 1px solid rgba(255, 255, 255, 0.2);
      flex: 1;
      overflow-y: auto;
      padding: 25px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      margin-bottom: 20px;
      min-height: 400px;
    }
    
    .message { 
      margin: 15px 0;
      padding: 15px 18px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-in;
      font-size: 1.1em;
      line-height: 1.5;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user { 
      text-align: right;
      background: linear-gradient(135deg, #ffffff, #e5e5e5);
      color: #333;
      margin-left: auto;
      border-bottom-right-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-weight: 500;
    }
    
    .ai { 
      text-align: left;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      color: white;
      margin-right: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-bottom-left-radius: 4px;
    }
    
    .timer-msg { 
      text-align: center;
      color: #ff6b6b;
      font-weight: bold;
      font-size: 1.2em;
      background: rgba(255, 107, 107, 0.1);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      margin: 20px auto;
      max-width: 90%;
    }
    
    .debug-info {
      background: rgba(59, 130, 246, 0.1);
      border-left: 3px solid #3b82f6;
      color: #93c5fd;
      font-size: 0.9em;
      padding: 8px 12px;
      margin: 8px auto;
      border-radius: 5px;
      max-width: 95%;
      font-family: monospace;
    }
    
    #inputArea { 
      margin-top: 15px;
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    #input { 
      flex: 1;
      padding: 15px;
      font-size: 1.1em;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      outline: none;
      transition: all 0.3s ease;
      resize: none;
      min-height: 50px;
      max-height: 100px;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    #input::placeholder {
      color: rgba(255, 255, 255, 0.6);
      font-size: 1em;
    }
    
    #input:focus {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.15);
    }
    
    #sendBtn { 
      padding: 15px 25px;
      background: linear-gradient(135deg, #ffffff, #e5e5e5);
      color: black;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1em;
      transition: all 0.3s ease;
      min-width: 80px;
    }
    
    #sendBtn:hover:not(.disabled) {
      background: linear-gradient(135deg, #f0f0f0, #d0d0d0);
      transform: translateY(-1px);
    }
    
    .btn-level {
      margin: 8px;
      padding: 15px 25px;
      font-size: 1.1em;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 25px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-weight: 500;
      transition: all 0.3s ease;
      min-width: 120px;
    }
    
    .btn-level:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.6);
      transform: translateY(-1px);
    }
    
    .timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1.1em;
      display: none;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .disabled { 
      background: #4a4a4a !important;
      color: #888 !important;
      cursor: not-allowed !important;
      transform: none !important;
    }
    
    .question-counter {
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      font-size: 1em;
      margin: 12px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Custom scrollbar */
    #chat::-webkit-scrollbar {
      width: 8px;
    }
    
    #chat::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
      body {
        max-width: 100%;
      }
      
      .container {
        margin: 5px;
        padding: 15px;
        height: calc(100vh - 10px);
      }
      
      h2 {
        font-size: 1.8em;
      }
      
      .auth-form {
        padding: 20px;
      }
      
      .message {
        font-size: 1em;
        padding: 12px 15px;
        max-width: 85%;
      }
      
      #input {
        font-size: 1em;
        padding: 12px;
      }
      
      #sendBtn {
        font-size: 1em;
        padding: 12px 20px;
      }
    }
  </style>
</head>
<body>

<div class="timer" id="timer">Time: 3:00</div>

<div class="container">
  <button class="logout-btn" id="logoutBtn" style="display: none;" onclick="logout()">Logout</button>
  
  <!-- Authentication Container -->
  <div class="auth-container" id="authContainer">
    <h2>🎯 AI Interview Hub</h2>
    
    <!-- Login Form -->
    <div class="auth-form" id="loginForm">
      <h3>Login</h3>
      <div id="loginMessage"></div>
      <div class="form-group">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" placeholder="Enter your email" required>
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password" required>
      </div>
      <button class="auth-btn" onclick="login()">Login</button>
      <div class="auth-switch">
        Don't have an account? <a onclick="showSignup()">Sign up here</a>
      </div>
    </div>
    
    <!-- Signup Form -->
    <div class="auth-form" id="signupForm" style="display: none;">
      <h3>Sign Up</h3>
      <div id="signupMessage"></div>
      <div class="form-group">
        <label for="signupName">Full Name</label>
        <input type="text" id="signupName" placeholder="Enter your full name" required>
      </div>
      <div class="form-group">
        <label for="signupEmail">Email</label>
        <input type="email" id="signupEmail" placeholder="Enter your email" required>
      </div>
      <div class="form-group">
        <label for="signupPassword">Password</label>
        <input type="password" id="signupPassword" placeholder="Create a password (min 6 characters)" required>
      </div>
      <button class="auth-btn" onclick="signup()">Sign Up</button>
      <div class="auth-switch">
        Already have an account? <a onclick="showLogin()">Login here</a>
      </div>
    </div>
  </div>
  
  <!-- Interview Container -->
  <div class="interview-container" id="interviewContainer">
    <h2>🎯 AI Interview Hub</h2>
    <div class="user-info" id="userInfo"></div>
    <div class="question-counter" id="questionCounter" style="display: none;">
      Q<span id="currentQuestion">1</span>: <span id="currentTopic">Fundamentals</span>
    </div>
    <div id="chat"></div>

    <div id="inputArea">
      <textarea id="input" placeholder="Type your answer..." autocomplete="off" rows="1"></textarea>
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
  // Authentication state
  let currentUser = null;
  let users = JSON.parse(window.localStorage?.getItem('interviewUsers') || '{}') || {};
  
  // Interview state
  const chat = document.getElementById('chat');
  let input = document.getElementById('input');
  let sendBtn = document.getElementById('sendBtn');
  const inputArea = document.getElementById('inputArea');
  const questionCounter = document.getElementById('questionCounter');
  const currentQuestionSpan = document.getElementById('currentQuestion');
  const currentTopicSpan = document.getElementById('currentTopic');

  let step = 0;
  let skill = '';
  let level = '';
  let interviewStartTime = null;
  let interviewEnded = false;
  let timerStarted = false;
  
  let sessionId = 'session-' + Date.now() + '-' + Math.floor(Math.random() * 100000);
  let questionIndex = 0;
  let totalQuestionsAsked = 0;

  // Enhanced question banks
  const questionBanks = {
    'sql': {
      'Beginner': [
        "What is SQL and what does it stand for?",
        "Explain the difference between SELECT, INSERT, UPDATE, and DELETE statements.",
        "What is a primary key and why is it important in database design?",
        "How do you retrieve all records from a table called 'employees'?",
        "What's the difference between WHERE and HAVING clauses?"
      ],
      'Intermediate': [
        "Explain the different types of SQL JOINs with practical examples.",
        "How would you find the second highest salary from an employees table?",
        "What are database indexes and how do they improve query performance?",
        "Write a query to find and remove duplicate records from a table.",
        "Explain the difference between UNION and UNION ALL operations."
      ],
      'Advanced': [
        "How would you optimize a slow-performing complex SQL query?",
        "Explain window functions and provide a real-world use case.",
        "What are stored procedures and when should you use them over regular queries?",
        "How do you ensure database transactions maintain ACID properties?",
        "Describe your approach to designing database schemas for scalable applications."
      ]
    },
    'java': {
      'Beginner': [
        "What is Java and what are its main features that make it popular?",
        "Explain the difference between JDK, JRE, and JVM.",
        "What are the primitive data types in Java and their memory sizes?",
        "How do you handle user input in a Java console application?",
        "What's the difference between == and .equals() when comparing strings?"
      ],
      'Intermediate': [
        "Explain inheritance, polymorphism, and encapsulation in Java.",
        "What's the difference between ArrayList and LinkedList performance-wise?",
        "How does exception handling work with try-catch-finally blocks?",
        "When would you use an interface versus an abstract class?",
        "Explain how multithreading works and potential synchronization issues."
      ],
      'Advanced': [
        "How does Java's garbage collection work and what are the different GC algorithms?",
        "Describe design patterns you've implemented in production Java code.",
        "How do Java 8+ Streams improve code readability and performance?",
        "What strategies do you use for Java application performance optimization?",
        "How do you design and implement scalable microservices in Java?"
      ]
    },
    'python': {
      'Beginner': [
        "What makes Python different from other programming languages?",
        "Explain the difference between lists, tuples, and dictionaries in Python.",
        "How do you handle exceptions using try-except blocks in Python?",
        "What are Python's built-in data types and when do you use each?",
        "How do you read from and write to files in Python?"
      ],
      'Intermediate': [
        "Explain list comprehensions and when they're more efficient than regular loops.",
        "What are Python decorators and how do you create custom ones?",
        "How does Python's memory management and garbage collection work?",
        "What's the difference between shallow copy and deep copy?",
        "Explain generators, yield keyword, and their memory advantages."
      ],
      'Advanced': [
        "What techniques do you use to optimize Python code performance?",
        "Explain metaclasses and provide a practical use case.",
        "How do you structure and test large Python applications?",
        "What's your approach to handling concurrency in Python applications?",
        "How do you design scalable REST APIs using Python frameworks?"
      ]
    },
    'manual testing': {
      'Beginner': [
        "What is manual testing and how does it differ from automated testing?",
        "Walk me through the basic manual testing process from start to finish.",
        "What are test cases and what key elements should they contain?",
        "Explain the difference between verification and validation in testing.",
        "What are the main types of manual testing you're familiar with?"
      ],
      'Intermediate': [
        "How do you prioritize test cases when working with tight deadlines?",
        "What testing techniques do you use to ensure comprehensive coverage?",
        "How do you adapt your testing approach for Agile development cycles?",
        "Describe your process for exploratory testing and finding edge cases.",
        "How do you maintain traceability between requirements and test execution?"
      ],
      'Advanced': [
        "How do you design a comprehensive test strategy for complex applications?",
        "Explain your approach to risk-based testing and resource allocation.",
        "How do you mentor junior testers and establish testing best practices?",
        "What's your strategy for balancing manual testing with test automation?",
        "What metrics and KPIs do you use to measure testing effectiveness?"
      ]
    }
  };

  // Authentication Functions
  function showMessage(elementId, message, type = 'error') {
    const element = document.getElementById(elementId);
    element.innerHTML = `<div class="${type}-msg">${message}</div>`;
    setTimeout(() => {
      element.innerHTML = '';
    }, 3000);
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email);
  }

  function showLogin() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('signupForm').style.display = 'none';
  }

  function showSignup() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'block';
  }

  function signup() {
    const name = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;

    if (!name) {
      showMessage('signupMessage', 'Please enter your full name');
      return;
    }

    if (!isValidEmail(email)) {
      showMessage('signupMessage', 'Please enter a valid email address');
      return;
    }

    if (password.length < 6) {
      showMessage('signupMessage', 'Password must be at least 6 characters long');
      return;
    }

    if (users[email]) {
      showMessage('signupMessage', 'An account with this email already exists');
      return;
    }

    // Create new user
    users[email] = {
      name: name,
      email: email,
      password: password,
      createdAt: new Date().toISOString()
    };

    // Save to storage (in production, this would be handled server-side)
    try {
      if (window.localStorage) {
        window.localStorage.setItem('interviewUsers', JSON.stringify(users));
      }
    } catch (e) {
      console.log('Storage not available, using session data only');
    }

    showMessage('signupMessage', 'Account created successfully! Please login.', 'success');
    
    setTimeout(() => {
      showLogin();
      document.getElementById('loginEmail').value = email;
    }, 1500);
  }

  function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!isValidEmail(email)) {
      showMessage('loginMessage', 'Please enter a valid email address');
      return;
    }

    if (!password) {
      showMessage('loginMessage', 'Please enter your password');
      return;
    }

    const user = users[email];
    if (!user || user.password !== password) {
      showMessage('loginMessage', 'Invalid email or password');
      return;
    }

    // Login successful
    currentUser = user;
    showInterviewInterface();
  }

  function logout() {
    currentUser = null;
    document.getElementById('authContainer').style.display = 'flex';
    document.getElementById('interviewContainer').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
    
    // Reset interview state
    resetInterview();
    
    // Clear form fields
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    showLogin();
  }

  function showInterviewInterface() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('interviewContainer').style.display = 'flex';
    document.getElementById('logoutBtn').style.display = 'block';
    
    // Show user info
    document.getElementById('userInfo').textContent = `Welcome, ${currentUser.name}!`;
    
    // Start interview flow
    startInterviewFlow();
  }

  function resetInterview() {
    step = 0;
    skill = '';
    level = '';
    interviewStartTime = null;
    interviewEnded = false;
    timerStarted = false;
    sessionId = 'session-' + Date.now() + '-' + Math.floor(Math.random() * 100000);
    questionIndex = 0;
    totalQuestionsAsked = 0;
    
    // Clear chat
    chat.innerHTML = '';
    
    // Reset timer
    const timerElement = document.getElementById('timer');
    timerElement.style.display = 'none';
    timerElement.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
    
    // Reset question counter
    questionCounter.style.display = 'none';
    
    // Enable input
    if (input) {
      input.disabled = false;
      input.value = '';
      input.placeholder = "Type your answer...";
      input.classList.remove('disabled');
    }
    
    if (sendBtn) {
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
      sendBtn.classList.remove('disabled');
    }
  }

  // Interview Functions
  function addMessage(text, sender, isTimer = false, isDebug = false) {
    const div = document.createElement('div');
    let className = 'message ' + sender;
    if (isTimer) className += ' timer-msg';
    if (isDebug) className += ' debug-info';
    
    div.className = className;
    div.innerHTML = text.replace(/\n/g, '<br>');
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function updateQuestionCounter() {
    if (timerStarted && questionIndex > 0) {
      questionCounter.style.display = 'block';
      currentQuestionSpan.textContent = questionIndex;
      
      const topics = {
        1: "Fundamentals",
        2: "Concepts", 
        3: "Applications",
        4: "Best Practices",
        5: "Advanced Topics",
        6: "Problem Solving"
      };
      
      currentTopicSpan.textContent = topics[questionIndex] || "Discussion";
    }
  }

  function getRandomQuestion() {
    const skillLower = skill.toLowerCase();
    const skillQuestions = questionBanks[skillLower];
    
    if (skillQuestions && skillQuestions[level]) {
      const questionPool = skillQuestions[level];
      const usedQuestions = window.usedQuestions || [];
      
      const availableQuestions = questionPool.filter((q, index) => !usedQuestions.includes(index));
      
      if (availableQuestions.length === 0) {
        window.usedQuestions = [];
        const randomIndex = Math.floor(Math.random() * questionPool.length);
        window.usedQuestions.push(randomIndex);
        return questionPool[randomIndex];
      }
      
      const randomIndex = Math.floor(Math.random() * availableQuestions.length);
      const selectedQuestion = availableQuestions[randomIndex];
      const originalIndex = questionPool.indexOf(selectedQuestion);
      
      if (!window.usedQuestions) window.usedQuestions = [];
      window.usedQuestions.push(originalIndex);
      
      return selectedQuestion;
    }
    
    const genericQuestions = {
      'Beginner': `What are the fundamental concepts of ${skill} that every beginner should know?`,
      'Intermediate': `How do you apply ${skill} in real projects and what challenges have you faced?`,
      'Advanced': `What advanced techniques and best practices do you follow when working with ${skill}?`
    };
    
    return genericQuestions[level] || `Tell me about your experience with ${skill}.`;
  }

  function getContextualFollowUp(userAnswer) {
    const answerLength = userAnswer.trim().length;
    
    const isWeakAnswer = answerLength < 15 || 
                        userAnswer.toLowerCase().includes('dont know') ||
                        userAnswer.toLowerCase().includes('no idea') ||
                        userAnswer.toLowerCase().includes('not sure') ||
                        userAnswer.toLowerCase() === 'yes' ||
                        userAnswer.toLowerCase() === 'no' ||
                        userAnswer.toLowerCase() === 'okay' ||
                        userAnswer.toLowerCase() === 'ok';
    
    if (isWeakAnswer) {
      const encouragements = [
        "No problem! Let me ask something more specific.",
        "That's okay! Here's a different question to help you show your knowledge.",
        "Let's try a more targeted question."
      ];
      const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
      setTimeout(() => addMessage(randomEncouragement, "ai"), 500);
    } else {
      const feedbacks = ["Good point!", "I see!", "Interesting!", "That's helpful!", "Good explanation!"];
      const randomFeedback = feedbacks[Math.floor(Math.random() * feedbacks.length)];
      setTimeout(() => addMessage(`${randomFeedback} Let me ask about another aspect.`, "ai"), 500);
    }
    
    return getRandomQuestion();
  }

  function disableInput() {
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = "Ended";
    sendBtn.classList.add('disabled');
    input.classList.add('disabled');
    input.placeholder = "Interview completed";
  }

  function startInterviewTimer() {
    if (timerStarted) return;
    
    timerStarted = true;
    interviewStartTime = Date.now();
    
    addMessage("⏱️ Your 3-minute interview starts now!", "ai", true);
    
    const timerElement = document.getElementById('timer');
    timerElement.style.display = 'block';
    
    const timerInterval = setInterval(() => {
      const remaining = getRemainingTime();
      const minutes = Math.floor(remaining / 60);
      const seconds = remaining % 60;
      timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      if (remaining === 30) {
        addMessage("⚠️ 30 seconds left!", "ai", true);
      }
      
      if (remaining <= 0) {
        clearInterval(timerInterval);
        endInterview();
      }
    }, 1000);
  }

  function endInterview() {
    if (interviewEnded) return;
    
    interviewEnded = true;
    addMessage("⏰ Time's up! Interview completed.", "ai", true);
    addMessage(`📊 Questions answered: ${totalQuestionsAsked}`, "ai");
    disableInput();
    
    const timerElement = document.getElementById('timer');
    timerElement.style.background = '#4a4a4a';
    timerElement.textContent = 'Done';
  }

  function getRemainingTime() {
    if (!interviewStartTime) return 180;
    const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
    return Math.max(0, 180 - elapsed);
  }

  async function sendMessage() {
    const message = input.value.trim();
    if (!message || interviewEnded) return;

    addMessage(message, 'user');
    input.value = '';
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = '...';

    if (step === 0) {
      skill = message.trim();
      if (skill.length < 2) {
        addMessage("Please enter a valid technical skill.", "ai");
        enableInput();
        return;
      }
      step++;
      setTimeout(() => {
        addMessage(`Perfect! Choose your ${skill} level:`, "ai");
        showLevelOptions();
      }, 600);
      return;
    } 
    else if (step === 2) {
      if (getRemainingTime() <= 0) {
        endInterview();
        return;
      }

      totalQuestionsAsked++;
      
      // Try webhook first, then fallback
      try {
        const response = await fetch('https://interviewainumpy.app.n8n.cloud/webhook/virtual-interview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            sessionId: sessionId,
            name: currentUser.name,
            email: currentUser.email,
            password: currentUser.password,
            skill: skill,
            level: level,
            userMessage: message,
            questionIndex: questionIndex + 1,
            step: questionIndex === 0 ? 'start_interview' : 'ongoing_interview'
          }),
        });

        if (response.ok) {
          const data = await response.json();
          if (data?.reply?.trim()?.length > 15) {
            setTimeout(() => {
              addMessage(data.reply, 'ai');
              questionIndex++;
              updateQuestionCounter();
            }, 800);
            enableInput();
            return;
          }
        }
      } catch (err) {
        addMessage("🔧 Using offline mode", "ai", false, true);
      }

      // Local fallback
      setTimeout(() => {
        const nextQuestion = getContextualFollowUp(message);
        setTimeout(() => {
          addMessage(nextQuestion, 'ai');
          questionIndex++;
          updateQuestionCounter();
        }, 800);
      }, 600);
    }

    enableInput();
  }

  function enableInput() {
    if (!interviewEnded && getRemainingTime() > 0) {
      input.disabled = false;
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
      input.focus();
    }
  }

  function showLevelOptions() {
    inputArea.innerHTML = `
      <div style="display: flex; flex-wrap: wrap; justify-content: center; width: 100%; gap: 10px;">
        <button class="btn-level" onclick="selectLevel('Beginner')">Beginner</button>
        <button class="btn-level" onclick="selectLevel('Intermediate')">Intermediate</button>
        <button class="btn-level" onclick="selectLevel('Advanced')">Advanced</button>
      </div>
    `;
  }

  async function selectLevel(selected) {
    level = selected;
    step = 2;
    addMessage(selected, 'user');
    addMessage("Setting up your interview...", "ai");

    // Restore input
    inputArea.innerHTML = `
      <textarea id="input" placeholder="Type your answer..." autocomplete="off" rows="1"></textarea>
      <button id="sendBtn">Send</button>
    `;
    
    input = document.getElementById('input');
    sendBtn = document.getElementById('sendBtn');
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    sendBtn.onclick = sendMessage;

    startInterviewTimer();
    
    setTimeout(() => {
      const firstQuestion = getRandomQuestion();
      addMessage(firstQuestion, 'ai');
      questionIndex = 1;
      updateQuestionCounter();
      enableInput();
    }, 1200);
  }

  function startInterviewFlow() {
    resetInterview();
    addMessage(`Hello ${currentUser.name}! 👋`, "ai");
    setTimeout(() => {
      addMessage("I'll interview you for 3 minutes. What skill should I interview you on?", "ai");
      enableInput();
    }, 1000);
  }

  // Initialize event listeners for interview
  function initializeInterviewListeners() {
    if (sendBtn) sendBtn.onclick = sendMessage;
    if (input) {
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auto-resize textarea
      input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
      });
    }
  }

  // Initialize the application
  document.addEventListener('DOMContentLoaded', function() {
    initializeInterviewListeners();
    
    // Check for existing login (in a real app, you'd use proper session management)
    const savedUser = null; // Disabled auto-login for security
    if (savedUser && users[savedUser.email]) {
      currentUser = users[savedUser.email];
      showInterviewInterface();
    }
  });

  // Initialize listeners
  initializeInterviewListeners();
</script>

</body>
</html>
