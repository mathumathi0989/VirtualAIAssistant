<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Interview Hub - Resume Based</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #000000 0%, #1A1A2E 50%, #16213E 100%);
      color: white;
      height: 100vh;
      width: 100%;
      max-width: 900px;
      overflow: hidden;
      position: relative;
      margin: 0 auto;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      height: calc(100vh - 20px);
      margin: 10px;
      padding: 25px;
      display: flex;
      flex-direction: column;
    }
    
    h2 {
      text-align: center;
      color: white;
      margin-bottom: 20px;
      font-size: 2.2em;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 15px;
    }

    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }
    
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      font-size: 1.1em;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      outline: none;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    
    .form-group input::placeholder, .form-group textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .form-group input:focus, .form-group textarea:focus {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 120px;
    }

    .primary-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #ffffff, #e5e5e5);
      color: black;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1em;
      transition: all 0.3s ease;
      margin-bottom: 15px;
    }
    
    .primary-btn:hover {
      background: linear-gradient(135deg, #f0f0f0, #d0d0d0);
      transform: translateY(-1px);
    }

    .error-msg {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9em;
    }
    
    .success-msg {
      background: rgba(72, 187, 120, 0.2);
      color: #48bb78;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(72, 187, 120, 0.3);
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9em;
    }

    /* Resume Upload Styles */
    .resume-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .upload-section {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 20px;
    }
    
    .file-upload-area {
      border: 2px dashed rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }
    
    .file-upload-area:hover {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.05);
    }
    
    .file-upload-area.dragover {
      border-color: #6BD6A8;
      background: rgba(107, 214, 168, 0.1);
    }
    
    .upload-icon {
      font-size: 3em;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 15px;
    }
    
    .upload-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1em;
      margin-bottom: 15px;
    }
    
    .file-input {
      display: none;
    }
    
    .choose-file-btn {
      background: linear-gradient(135deg, #f093fb, #f5576c);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .choose-file-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
    }
    
    .file-info {
      background: rgba(72, 187, 120, 0.2);
      color: #48bb78;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid rgba(72, 187, 120, 0.3);
      margin-top: 15px;
      display: none;
      font-size: 0.9em;
    }

    /* Interview Type Selection */
    .interview-type-selection {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      max-width: 600px;
      margin: 0 auto;
    }

    .selection-section {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 20px;
    }

    .selection-title {
      text-align: center;
      color: #6BD6A8;
      font-size: 1.8em;
      margin-bottom: 20px;
    }

    .selection-subtitle {
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1em;
      margin-bottom: 30px;
    }

    .option-cards {
      display: flex;
      gap: 20px;
      width: 100%;
      flex-wrap: wrap;
    }
    
    .option-card {
      flex: 1;
      min-width: 280px;
      padding: 30px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      text-align: center;
    }
    
    .chat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .audio-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      position: relative;
    }

    .coming-soon {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7em;
      font-weight: bold;
    }
    
    .option-card:hover {
      transform: translateY(-5px);
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .option-card.disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    .option-card.disabled:hover {
      transform: none;
      border-color: transparent;
      box-shadow: none;
    }
    
    .option-card h4 {
      font-size: 1.5em;
      margin-bottom: 15px;
      color: white;
    }
    
    .option-card p {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1em;
      line-height: 1.5;
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Interview Chat Styles */
    .interview-container {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    .user-info {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.8);
    }
    
    #chat { 
      border: 1px solid rgba(255, 255, 255, 0.2);
      flex: 1;
      overflow-y: auto;
      padding: 25px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      margin-bottom: 20px;
      min-height: 400px;
    }
    
    .message { 
      margin: 15px 0;
      padding: 15px 18px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-in;
      font-size: 1.1em;
      line-height: 1.5;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user { 
      text-align: right;
      background: linear-gradient(135deg, #ffffff, #e5e5e5);
      color: #333;
      margin-left: auto;
      border-bottom-right-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-weight: 500;
    }
    
    .ai { 
      text-align: left;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      color: white;
      margin-right: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-bottom-left-radius: 4px;
    }
    
    .timer-msg { 
      text-align: center;
      color: #ff6b6b;
      font-weight: bold;
      font-size: 1.2em;
      background: rgba(255, 107, 107, 0.1);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      margin: 20px auto;
      max-width: 90%;
    }

    .loading-msg {
      text-align: center;
      color: #6BD6A8;
      font-style: italic;
      background: rgba(107, 214, 168, 0.1);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(107, 214, 168, 0.3);
      margin: 15px auto;
      max-width: 90%;
    }
    
    #inputArea { 
      margin-top: 15px;
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    #input { 
      flex: 1;
      padding: 15px;
      font-size: 1.1em;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      outline: none;
      transition: all 0.3s ease;
      resize: none;
      min-height: 50px;
      max-height: 100px;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    #input::placeholder {
      color: rgba(255, 255, 255, 0.6);
      font-size: 1em;
    }
    
    #input:focus {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.15);
    }
    
    #sendBtn { 
      padding: 15px 25px;
      background: linear-gradient(135deg, #ffffff, #e5e5e5);
      color: black;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1em;
      transition: all 0.3s ease;
      min-width: 80px;
    }
    
    #sendBtn:hover:not(.disabled) {
      background: linear-gradient(135deg, #f0f0f0, #d0d0d0);
      transform: translateY(-1px);
    }
    
    .timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1.1em;
      display: none;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .disabled { 
      background: #4a4a4a !important;
      color: #888 !important;
      cursor: not-allowed !important;
      transform: none !important;
    }
    
    .question-counter {
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      font-size: 1em;
      margin: 12px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Custom scrollbar */
    #chat::-webkit-scrollbar {
      width: 8px;
    }
    
    #chat::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        max-width: 100%;
      }
      
      .container {
        margin: 5px;
        padding: 15px;
        height: calc(100vh - 10px);
      }
      
      h2 {
        font-size: 1.8em;
      }
      
      .upload-section, .selection-section {
        padding: 20px;
      }
      
      .option-cards {
        flex-direction: column;
        gap: 15px;
      }
      
      .option-card {
        min-width: 100%;
      }
      
      .message {
        font-size: 1em;
        padding: 12px 15px;
        max-width: 85%;
      }
      
      #input {
        font-size: 1em;
        padding: 12px;
      }
      
      #sendBtn {
        font-size: 1em;
        padding: 12px 20px;
      }
    }
  </style>
</head>
<body>

<div class="timer" id="timer">Time: 3:00</div>

<div class="container">
  <button class="back-btn" id="backBtn" style="display: none;" onclick="goBack()">‚Üê Back</button>
  
  <!-- Resume Upload Container -->
  <div class="resume-container" id="resumeContainer">
    <h2>üìÑ AI Interview Hub</h2>
    <div class="upload-section">
      <div class="form-group">
        <label>Resume *</label>
        <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('resumeFile').click()">
          <div class="upload-icon">üì§</div>
          <div class="upload-text">Click to upload your resume</div>
          <button type="button" class="choose-file-btn">Choose File</button>
          <input type="file" id="resumeFile" class="file-input" accept=".pdf,.doc,.docx,.txt" onchange="handleFileUpload(this)">
        </div>
        <div class="file-info" id="fileInfo"></div>
      </div>
      
      <div class="form-group">
        <label for="jobDescription">Job Description (Optional)</label>
        <textarea id="jobDescription" placeholder="Paste the job description here..." rows="5"></textarea>
      </div>
      
      <button class="primary-btn" onclick="proceedToInterviewType()">Continue</button>
    </div>
  </div>

  <!-- Interview Type Selection -->
  <div class="interview-type-selection" id="interviewTypeSelection">
    <h2>üéØ Choose Interview Mode</h2>
    <div class="selection-section">
      <h3 class="selection-title">How would you like to be interviewed?</h3>
      <p class="selection-subtitle">Select your preferred interview format</p>
      
      <div class="option-cards">
        <div class="option-card chat-card" onclick="startChatInterview()">
          <h4>üí¨ Chat Interview</h4>
          <p>Text-based interview with AI interviewer</p>
        </div>
        <div class="option-card audio-card disabled" onclick="showComingSoon()">
          <div class="coming-soon">Coming Soon</div>
          <h4>üé§ Audio Interview</h4>
          <p>Voice-based interview with AI interviewer</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Interview Container -->
  <div class="interview-container" id="interviewContainer">
    <h2>üéØ AI Interview Hub</h2>
    <div class="user-info" id="userInfo"></div>
    <div class="question-counter" id="questionCounter" style="display: none;">
      Q<span id="currentQuestion">1</span>: Interview in Progress
    </div>
    <div id="chat"></div>

    <div id="inputArea">
      <textarea id="input" placeholder="Type your answer..." autocomplete="off" rows="1"></textarea>
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
  // Interview state
  const chat = document.getElementById('chat');
  let input = document.getElementById('input');
  let sendBtn = document.getElementById('sendBtn');
  const inputArea = document.getElementById('inputArea');
  const questionCounter = document.getElementById('questionCounter');
  const currentQuestionSpan = document.getElementById('currentQuestion');

  let resumeFile = null;
  let resumeContent = '';
  let jobDescription = '';
  let interviewStartTime = null;
  let interviewEnded = false;
  let timerStarted = false;
  
  let sessionId = '';
  let questionIndex = 0;
  let totalQuestionsAsked = 0;
  let conversationHistory = [];

  // Generate session ID
  function generateSessionId() {
    return 'session-' + Math.random().toString(36).substr(2, 16) + '-' + Date.now().toString(36);
  }

  function showMessage(elementId, message, type = 'error') {
    const element = document.getElementById(elementId);
    if (element) {
      element.innerHTML = `<div class="${type}-msg">${message}</div>`;
      setTimeout(() => {
        element.innerHTML = '';
      }, 3000);
    }
  }

  function goBack() {
    const resumeContainer = document.getElementById('resumeContainer');
    const interviewTypeSelection = document.getElementById('interviewTypeSelection');
    const interviewContainer = document.getElementById('interviewContainer');
    
    if (interviewContainer.style.display === 'flex') {
      interviewContainer.style.display = 'none';
      interviewTypeSelection.style.display = 'flex';
      resetInterview();
      return;
    }
    
    if (interviewTypeSelection.style.display === 'flex') {
      interviewTypeSelection.style.display = 'none';
      resumeContainer.style.display = 'flex';
      document.getElementById('backBtn').style.display = 'none';
      return;
    }
  }

  // File Upload Functions
  function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const validTypes = ['application/pdf', 'application/msword', 
                       'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
                       'text/plain'];
    if (!validTypes.includes(file.type)) {
      alert('Please upload a PDF, DOC, DOCX, or TXT file.');
      input.value = '';
      return;
    }

    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
      alert('File size must be less than 5MB.');
      input.value = '';
      return;
    }

    resumeFile = file;
    const fileInfo = document.getElementById('fileInfo');
    fileInfo.innerHTML = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    fileInfo.style.display = 'block';
  }

  // Helper function to convert file to text
  async function fileToText(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        if (file.type === 'application/pdf') {
          resolve(reader.result); // Return base64 for PDF
        } else {
          resolve(reader.result); // Return text content for TXT/DOC
        }
      };
      reader.onerror = () => reject(reader.error);
      
      if (file.type === 'text/plain') {
        reader.readAsText(file);
      } else {
        reader.readAsDataURL(file);
      }
    });
  }

  async function proceedToInterviewType() {
    if (!resumeFile) {
      alert('Please upload your resume first.');
      return;
    }

    try {
      resumeContent = await fileToText(resumeFile);
      jobDescription = document.getElementById('jobDescription').value.trim();
      
      sessionId = generateSessionId();
      
      document.getElementById('resumeContainer').style.display = 'none';
      document.getElementById('interviewTypeSelection').style.display = 'flex';
      document.getElementById('backBtn').style.display = 'block';
      
    } catch (error) {
      console.error('Error processing resume:', error);
      alert('Error processing resume file. Please try again.');
    }
  }

  function showComingSoon() {
    alert('üé§ Audio Interview feature is coming soon! Please try the Chat Interview for now.');
  }

  function startChatInterview() {
    document.getElementById('interviewTypeSelection').style.display = 'none';
    document.getElementById('interviewContainer').style.display = 'flex';
    
    startResumeBasedInterview();
  }

  function resetInterview() {
    interviewStartTime = null;
    interviewEnded = false;
    timerStarted = false;
    questionIndex = 0;
    totalQuestionsAsked = 0;
    conversationHistory = [];
    
    if (chat) chat.innerHTML = '';
    
    const timerElement = document.getElementById('timer');
    timerElement.style.display = 'none';
    timerElement.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
    
    questionCounter.style.display = 'none';
    
    if (input) {
      input.disabled = false;
      input.value = '';
      input.placeholder = "Type your answer...";
      input.classList.remove('disabled');
    }
    
    if (sendBtn) {
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
      sendBtn.classList.remove('disabled');
    }
  }

  // Interview Functions
  function addMessage(text, sender, isTimer = false, isLoading = false) {
    const div = document.createElement('div');
    let className = 'message ' + sender;
    if (isTimer) className += ' timer-msg';
    if (isLoading) className += ' loading-msg';
    
    div.className = className;
    div.innerHTML = text.replace(/\n/g, '<br>');
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    
    return div;
  }

  function updateQuestionCounter() {
    if (timerStarted && questionIndex > 0) {
      questionCounter.style.display = 'block';
      currentQuestionSpan.textContent = questionIndex;
    }
  }

  function disableInput() {
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = "Ended";
    sendBtn.classList.add('disabled');
    input.classList.add('disabled');
    input.placeholder = "Interview completed";
  }

  function enableInput() {
    if (!interviewEnded) {
      input.disabled = false;
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
    }
  }

  function startInterviewTimer() {
    if (timerStarted) return;
    
    timerStarted = true;
    interviewStartTime = Date.now();
    
    addMessage("‚è±Ô∏è Your 3-minute interview starts now!", "ai", true);
    
    const timerElement = document.getElementById('timer');
    timerElement.style.display = 'block';
    
    const timerInterval = setInterval(() => {
      const remaining = getRemainingTime();
      const minutes = Math.floor(remaining / 60);
      const seconds = remaining % 60;
      timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      if (remaining === 30) {
        addMessage("‚ö†Ô∏è 30 seconds left!", "ai", true);
      }
      
      if (remaining <= 0) {
        clearInterval(timerInterval);
        endInterview();
      }
    }, 1000);
  }

  function endInterview() {
    if (interviewEnded) return;
    
    interviewEnded = true;
    addMessage("‚è∞ Time's up! Interview completed.", "ai", true);
    addMessage(`üìä Questions answered: ${totalQuestionsAsked}`, "ai");
    disableInput();
    
    const timerElement = document.getElementById('timer');
    timerElement.style.background = '#4a4a4a';
    timerElement.textContent = 'Done';
  }

  function getRemainingTime() {
    if (!interviewStartTime) return 180;
    const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
    return Math.max(0, 180 - elapsed);
  }

  // AI Interview Function - FIXED
  async function callAIInterviewer(userMessage, isFirstMessage = false) {
    console.log('=== CALL AI INTERVIEWER ===');
    console.log('Resume content length:', resumeContent ? resumeContent.length : 0);
    console.log('Job description length:', jobDescription ? jobDescription.length : 0);

    const loadingMessage = addMessage("AI is thinking...", "ai", false, true);
    
    // Add user message to conversation history
    if (userMessage && userMessage.trim()) {
        conversationHistory.push({
            role: "user",
            message: userMessage
        });
    }

    // Prepare the request body matching your n8n workflow expectations
    let requestBody = {
      sessionId: sessionId,
      name: "User",
      email: "user@example.com", 
      userMessage: userMessage || "",
      questionIndex: questionIndex + 1,
      totalQuestionsAsked: totalQuestionsAsked,
      conversationHistory: JSON.stringify(conversationHistory),
      interviewType: "resume",
      step: isFirstMessage ? 'start_interview' : 'ongoing_interview',
      remainingTime: getRemainingTime(),
      resumeContent: resumeContent || null,
      jobDescription: jobDescription || null,
      resumeFileName: resumeFile ? resumeFile.name : null
    };

    console.log('=== REQUEST BODY ===');
    console.log('Step:', requestBody.step);
    console.log('Resume filename:', requestBody.resumeFileName);
    
    try {
        // Call your n8n webhook - UPDATED URL
        const response = await fetch('https://mathumqa.app.n8n.cloud/webhook/mathu-interview', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        // Remove loading message
        if (chat.contains(loadingMessage)) {
            chat.removeChild(loadingMessage);
        }

        if (response.ok) {
            const data = await response.json();
            console.log('AI Response:', data);
            
            let aiReply = '';
            
            // Handle different possible response formats from your n8n workflow
            if (data && typeof data === 'object') {
                if (data.reply && typeof data.reply === 'string' && data.reply.trim().length > 0) {
                    aiReply = data.reply.trim();
                } else if (data.output && typeof data.output === 'string' && data.output.trim().length > 0) {
                    aiReply = data.output.trim();
                } else if (data.cleanOutput && typeof data.cleanOutput === 'string' && data.cleanOutput.trim().length > 0) {
                    aiReply = data.cleanOutput.trim();
                } else if (typeof data === 'string' && data.trim().length > 0) {
                    aiReply = data.trim();
                } else {
                    // Check if the response is wrapped in another object
                    console.log('Full response structure:', JSON.stringify(data, null, 2));
                    throw new Error('No valid reply found in response');
                }
            }
            
            if (aiReply.length > 0) {
                // Add AI response to conversation history
                conversationHistory.push({
                    role: "assistant",
                    message: aiReply
                });
                
                addMessage(aiReply, 'ai');
                questionIndex++;
                updateQuestionCounter();
                return true;
            } else {
                console.error('Empty AI response received');
                throw new Error('Empty response from AI service');
            }
        } else {
            const errorText = await response.text();
            console.error('HTTP Error:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
    } catch (error) {
        console.error('AI service error:', error);
        
        // Remove loading message if still present
        if (chat.contains(loadingMessage)) {
            chat.removeChild(loadingMessage);
        }
        
        // Show fallback response
        generateFallbackResponse(userMessage, isFirstMessage);
        
        return false;
    }
  }

  // Enhanced fallback response
  function generateFallbackResponse(userMessage, isFirstMessage) {
    let response;
    
    if (isFirstMessage) {
        response = "Hello! I've reviewed your resume and I'm excited to learn more about your experience. Can you tell me about your most significant project and the key challenges you overcame?";
    } else {
        // Follow-up questions for when AI service is down
        const fallbackQuestions = [
            "That's helpful. Can you explain your approach to problem-solving in your field?",
            "Interesting. What technologies or tools do you consider essential in your work?",
            "Good point. How do you handle working under pressure or tight deadlines?",
            "Thanks for sharing. Can you describe a time you had to learn something new quickly?",
            "Thank you for your responses. What motivates you most in your professional work?"
        ];
        
        const questionIdx = Math.min(totalQuestionsAsked - 1, fallbackQuestions.length - 1);
        response = fallbackQuestions[questionIdx];
    }
    
    // Add AI response to conversation history
    conversationHistory.push({
        role: "assistant", 
        message: response
    });
    
    addMessage(response, 'ai');
    questionIndex++;
    updateQuestionCounter();
    return true;
  }

  async function sendMessage() {
    const message = input.value.trim();
    if (!message || interviewEnded) return;

    addMessage(message, 'user');
    input.value = '';
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = '...';

    if (getRemainingTime() <= 0) {
      endInterview();
      return;
    }

    totalQuestionsAsked++;
    
    // Call AI interviewer
    await callAIInterviewer(message, false);
    
    enableInput();
  }

  // Start Resume-Based Interview
  async function startResumeBasedInterview() {
    console.log('=== START RESUME BASED INTERVIEW ===');
    console.log('resumeContent length:', resumeContent ? resumeContent.length : 0);
    console.log('jobDescription length:', jobDescription ? jobDescription.length : 0);
    
    const jobDesc = jobDescription ? ' and job description' : '';
    document.getElementById('userInfo').innerHTML = `Interview Mode: Resume-based${jobDesc}`;
    
    addMessage("I'll analyze your resume and conduct an interview based on your experience and the role requirements.", 'ai');
    addMessage("Let me start the timer and begin with the first question.", 'ai');
    
    startInterviewTimer();
    
    // Start the interview with AI
    await callAIInterviewer("", true); // First message - no user input yet
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', function() {
    sendBtn.addEventListener('click', sendMessage);
    
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    // Auto-resize textarea
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    // Add drag and drop functionality
    const fileUploadArea = document.getElementById('fileUploadArea');
    
    fileUploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });
    
    fileUploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
    });
    
    fileUploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        document.getElementById('resumeFile').files = files;
        handleFileUpload(document.getElementById('resumeFile'));
      }
    });
  });
</script>

</body>
</html>
