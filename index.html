<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Interview Hub - Fixed</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #000000 0%, #1A1A2E 50%, #16213E 100%);
      color: white;
      height: 100vh;
      width: 100%;
      max-width: 900px;
      overflow: hidden;
      position: relative;
      margin: 0 auto;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      height: calc(100vh - 20px);
      margin: 10px;
      padding: 25px;
      display: flex;
      flex-direction: column;
    }
    
    h2 {
      text-align: center;
      color: white;
      margin-bottom: 20px;
      font-size: 2.2em;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 15px;
    }
    
    /* Authentication Styles */
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .auth-form {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .auth-form h3 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 1.8em;
      color: white;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }
    
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      font-size: 1.1em;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      outline: none;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    
    .form-group input::placeholder, .form-group textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .form-group input:focus, .form-group textarea:focus {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    .auth-btn, .primary-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #ffffff, #e5e5e5);
      color: black;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1em;
      transition: all 0.3s ease;
      margin-bottom: 15px;
    }
    
    .auth-btn:hover, .primary-btn:hover {
      background: linear-gradient(135deg, #f0f0f0, #d0d0d0);
      transform: translateY(-1px);
    }
    
    .auth-switch {
      text-align: center;
      margin-top: 20px;
    }
    
    .auth-switch a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    
    .auth-switch a:hover {
      color: white;
    }
    
    .error-msg {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9em;
    }
    
    .success-msg {
      background: rgba(72, 187, 120, 0.2);
      color: #48bb78;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(72, 187, 120, 0.3);
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9em;
    }
    
    /* Interview Options Styles */
    .interview-options {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .welcome-section {
      text-align: center;
      margin-bottom: 40px;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .welcome-section h3 {
      color: #6BD6A8;
      font-size: 1.8em;
      margin-bottom: 10px;
    }
    
    .welcome-section p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1em;
    }
    
    .option-cards {
      display: flex;
      gap: 20px;
      width: 100%;
      flex-wrap: wrap;
    }
    
    .option-card {
      flex: 1;
      min-width: 280px;
      padding: 30px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      text-align: center;
    }
    
    .skill-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .resume-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .option-card:hover {
      transform: translateY(-5px);
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    
    .option-card h4 {
      font-size: 1.5em;
      margin-bottom: 15px;
      color: white;
    }
    
    .option-card p {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1em;
      line-height: 1.5;
    }
    
    /* Resume Upload Styles */
    .resume-container, .skill-container {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .upload-section {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 20px;
    }
    
    .file-upload-area {
      border: 2px dashed rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }
    
    .file-upload-area:hover {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.05);
    }
    
    .file-upload-area.dragover {
      border-color: #6BD6A8;
      background: rgba(107, 214, 168, 0.1);
    }
    
    .upload-icon {
      font-size: 3em;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 15px;
    }
    
    .upload-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1em;
      margin-bottom: 15px;
    }
    
    .file-input {
      display: none;
    }
    
    .choose-file-btn {
      background: linear-gradient(135deg, #f093fb, #f5576c);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .choose-file-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
    }
    
    .file-info {
      background: rgba(72, 187, 120, 0.2);
      color: #48bb78;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid rgba(72, 187, 120, 0.3);
      margin-top: 15px;
      display: none;
      font-size: 0.9em;
    }
    
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Interview Chat Styles */
    .interview-container {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    .user-info {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.8);
    }
    
    #chat { 
      border: 1px solid rgba(255, 255, 255, 0.2);
      flex: 1;
      overflow-y: auto;
      padding: 25px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      margin-bottom: 20px;
      min-height: 400px;
    }
    
    .message { 
      margin: 15px 0;
      padding: 15px 18px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-in;
      font-size: 1.1em;
      line-height: 1.5;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user { 
      text-align: right;
      background: linear-gradient(135deg, #ffffff, #e5e5e5);
      color: #333;
      margin-left: auto;
      border-bottom-right-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-weight: 500;
    }
    
    .ai { 
      text-align: left;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      color: white;
      margin-right: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-bottom-left-radius: 4px;
    }
    
    .timer-msg { 
      text-align: center;
      color: #ff6b6b;
      font-weight: bold;
      font-size: 1.2em;
      background: rgba(255, 107, 107, 0.1);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      margin: 20px auto;
      max-width: 90%;
    }
    
    .debug-info {
      background: rgba(59, 130, 246, 0.1);
      border-left: 3px solid #3b82f6;
      color: #93c5fd;
      font-size: 0.9em;
      padding: 8px 12px;
      margin: 8px auto;
      border-radius: 5px;
      max-width: 95%;
      font-family: monospace;
    }

    .loading-msg {
      text-align: center;
      color: #6BD6A8;
      font-style: italic;
      background: rgba(107, 214, 168, 0.1);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(107, 214, 168, 0.3);
      margin: 15px auto;
      max-width: 90%;
    }
    
    #inputArea { 
      margin-top: 15px;
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    #input { 
      flex: 1;
      padding: 15px;
      font-size: 1.1em;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      outline: none;
      transition: all 0.3s ease;
      resize: none;
      min-height: 50px;
      max-height: 100px;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    #input::placeholder {
      color: rgba(255, 255, 255, 0.6);
      font-size: 1em;
    }
    
    #input:focus {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.15);
    }
    
    #sendBtn { 
      padding: 15px 25px;
      background: linear-gradient(135deg, #ffffff, #e5e5e5);
      color: black;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1em;
      transition: all 0.3s ease;
      min-width: 80px;
    }
    
    #sendBtn:hover:not(.disabled) {
      background: linear-gradient(135deg, #f0f0f0, #d0d0d0);
      transform: translateY(-1px);
    }
    
    .btn-level {
      margin: 8px;
      padding: 15px 25px;
      font-size: 1.1em;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 25px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-weight: 500;
      transition: all 0.3s ease;
      min-width: 120px;
    }
    
    .btn-level:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.6);
      transform: translateY(-1px);
    }
    
    .timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1.1em;
      display: none;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .disabled { 
      background: #4a4a4a !important;
      color: #888 !important;
      cursor: not-allowed !important;
      transform: none !important;
    }
    
    .question-counter {
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      font-size: 1em;
      margin: 12px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Custom scrollbar */
    #chat::-webkit-scrollbar {
      width: 8px;
    }
    
    #chat::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        max-width: 100%;
      }
      
      .container {
        margin: 5px;
        padding: 15px;
        height: calc(100vh - 10px);
      }
      
      h2 {
        font-size: 1.8em;
      }
      
      .auth-form, .upload-section {
        padding: 20px;
      }
      
      .option-cards {
        flex-direction: column;
        gap: 15px;
      }
      
      .option-card {
        min-width: 100%;
      }
      
      .message {
        font-size: 1em;
        padding: 12px 15px;
        max-width: 85%;
      }
      
      #input {
        font-size: 1em;
        padding: 12px;
      }
      
      #sendBtn {
        font-size: 1em;
        padding: 12px 20px;
      }
    }
  </style>
</head>
<body>

<div class="timer" id="timer">Time: 3:00</div>

<div class="container">
  <button class="logout-btn" id="logoutBtn" style="display: none;" onclick="logout()">Logout</button>
  <button class="back-btn" id="backBtn" style="display: none;" onclick="goBack()">‚Üê Back</button>
  
  <!-- Authentication Container -->
  <div class="auth-container" id="authContainer">
    <h2>üéØ AI Interview Hub</h2>
    
    <!-- Login Form -->
    <div class="auth-form" id="loginForm">
      <h3>Login</h3>
      <div id="loginMessage"></div>
      <div class="form-group">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" placeholder="Enter your email" required>
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password" required>
      </div>
      <button class="auth-btn" onclick="login()">Login</button>
      <div class="auth-switch">
        <a onclick="showForgotPassword()">Forgot Password?</a>
        <br><br>
        Don't have an account? <a onclick="showSignup()">Sign up here</a>
      </div>
    </div>
    
    <!-- Signup Form -->
    <div class="auth-form" id="signupForm" style="display: none;">
      <h3>Sign Up</h3>
      <div id="signupMessage"></div>
      <div class="form-group">
        <label for="signupName">Full Name</label>
        <input type="text" id="signupName" placeholder="Enter your full name" required>
      </div>
      <div class="form-group">
        <label for="signupEmail">Email</label>
        <input type="email" id="signupEmail" placeholder="Enter your email" required>
      </div>
      <div class="form-group">
        <label for="signupPassword">Password</label>
        <input type="password" id="signupPassword" placeholder="Create a password (min 6 characters)" required>
      </div>
      <button class="auth-btn" onclick="signup()">Sign Up</button>
      <div class="auth-switch">
        Already have an account? <a onclick="showLogin()">Login here</a>
      </div>
    </div>
    
    <!-- Forgot Password Form -->
    <div class="auth-form" id="forgotPasswordForm" style="display: none;">
      <h3>Reset Password</h3>
      <div id="forgotMessage"></div>
      <div class="form-group">
        <label for="forgotEmail">Email</label>
        <input type="email" id="forgotEmail" placeholder="Enter your email address" required>
      </div>
      <button class="auth-btn" onclick="sendResetLink()">Send Reset Link</button>
      <div class="auth-switch">
        Remember your password? <a onclick="showLogin()">Login here</a>
      </div>
    </div>
    
    <!-- Reset Password Form -->
    <div class="auth-form" id="resetPasswordForm" style="display: none;">
      <h3>Set New Password</h3>
      <div id="resetMessage"></div>
      <div class="form-group">
        <label for="resetCode">Reset Code</label>
        <input type="text" id="resetCode" placeholder="Enter the code from your email" required>
      </div>
      <div class="form-group">
        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password (min 6 characters)" required>
      </div>
      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm your new password" required>
      </div>
      <button class="auth-btn" onclick="resetPassword()">Reset Password</button>
      <div class="auth-switch">
        <a onclick="showLogin()">Back to Login</a>
      </div>
    </div>
  </div>
  
  <!-- Interview Options Container -->
  <div class="interview-options" id="interviewOptions">
    <h2>üéØ AI Interview Hub</h2>
    <div class="welcome-section">
      <h3>InterviewIQ Hub</h3>
      <p>Ready to Start the Interview?</p>
    </div>
    <div class="option-cards">
      <div class="option-card skill-card" onclick="selectInterviewType('skill')">
        <h4>Skill-Based Interview</h4>
        <p>Choose your skill and level of expertise</p>
      </div>
      <div class="option-card resume-card" onclick="selectInterviewType('resume')">
        <h4>Resume-Based Interview</h4>
        <p>Upload your resume and job description</p>
      </div>
    </div>
  </div>
  
  <!-- Resume Upload Container -->
  <div class="resume-container" id="resumeContainer">
    <h2>üìÑ Resume-Based Interview</h2>
    <div class="upload-section">
      <div class="form-group">
        <label>Resume *</label>
        <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('resumeFile').click()">
          <div class="upload-icon">üì§</div>
          <div class="upload-text">Click to upload your resume</div>
          <button type="button" class="choose-file-btn">Choose File</button>
          <input type="file" id="resumeFile" class="file-input" accept=".pdf,.doc,.docx" onchange="handleFileUpload(this)">
        </div>
        <div class="file-info" id="fileInfo"></div>
      </div>
      
      <div class="form-group">
        <label for="jobDescription">Job Description (Optional)</label>
        <textarea id="jobDescription" placeholder="Paste the job description here..." rows="5"></textarea>
      </div>
      
      <button class="primary-btn" onclick="startResumeInterview()">Continue to Interview Options</button>
    </div>
  </div>
  
  <!-- Skill Selection Container -->
  <div class="skill-container" id="skillContainer">
    <h2>üíª Skill-Based Interview</h2>
    <div class="upload-section">
      <div class="form-group">
        <label for="skillInput">What skill should I interview you on?</label>
        <input type="text" id="skillInput" placeholder="e.g., Java, Python, SQL, Manual Testing, etc." required>
      </div>
      <button class="primary-btn" onclick="proceedToSkillLevel()">Continue</button>
    </div>
  </div>
  
  <!-- Interview Container -->
  <div class="interview-container" id="interviewContainer">
    <h2>üéØ AI Interview Hub</h2>
    <div class="user-info" id="userInfo"></div>
    <div class="question-counter" id="questionCounter" style="display: none;">
      Q<span id="currentQuestion">1</span>: Interview in Progress
    </div>
    <div id="chat"></div>

    <div id="inputArea">
      <textarea id="input" placeholder="Type your answer..." autocomplete="off" rows="1"></textarea>
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
  // Authentication state
  let currentUser = null;
  let users = {};
  let resetCodes = {};
  
  // Interview state
  const chat = document.getElementById('chat');
  let input = document.getElementById('input');
  let sendBtn = document.getElementById('sendBtn');
  const inputArea = document.getElementById('inputArea');
  const questionCounter = document.getElementById('questionCounter');
  const currentQuestionSpan = document.getElementById('currentQuestion');

  let step = 0;
  let skill = '';
  let level = '';
  let interviewType = '';
  let resumeFile = null;
  let jobDescription = '';
  let interviewStartTime = null;
  let interviewEnded = false;
  let timerStarted = false;
  
  let sessionId = '';
  let questionIndex = 0;
  let totalQuestionsAsked = 0;
  let conversationHistory = [];

  // FIXED TRACKING VARIABLES
  let currentAIQuestion = null; // Stores the currently displayed AI question
  let questionId = 0;

  // Generate consistent session ID for user
  function generateSessionId(email) {
    return hashPassword(email + 'session-salt').then(hash => 'session-' + hash.substring(0, 16));
  }

  // Authentication Functions
  function showMessage(elementId, message, type = 'error') {
    const element = document.getElementById(elementId);
    element.innerHTML = `<div class="${type}-msg">${message}</div>`;
    setTimeout(() => {
      element.innerHTML = '';
    }, 3000);
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email);
  }

  // Hash password function
  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  }

  // Verify password function
  async function verifyPassword(enteredPassword, storedHashedPassword) {
    const hashedEnteredPassword = await hashPassword(enteredPassword);
    return hashedEnteredPassword === storedHashedPassword;
  }

  // Generate random reset code
  function generateResetCode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  // Simulate sending email (in production, this would call your email service)
  function simulateEmailSend(email, resetCode) {
    console.log(`üìß Email sent to ${email}`);
    console.log(`Reset Code: ${resetCode}`);
    console.log(`This would normally be sent via email service like SendGrid, AWS SES, etc.`);
    return true;
  }

  function showLogin() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('signupForm').style.display = 'none';
    document.getElementById('forgotPasswordForm').style.display = 'none';
    document.getElementById('resetPasswordForm').style.display = 'none';
  }

  function showSignup() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'block';
    document.getElementById('forgotPasswordForm').style.display = 'none';
    document.getElementById('resetPasswordForm').style.display = 'none';
  }

  function showForgotPassword() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'none';
    document.getElementById('forgotPasswordForm').style.display = 'block';
    document.getElementById('resetPasswordForm').style.display = 'none';
  }

  function showResetPassword() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'none';
    document.getElementById('forgotPasswordForm').style.display = 'none';
    document.getElementById('resetPasswordForm').style.display = 'block';
  }

  async function sendResetLink() {
    const email = document.getElementById('forgotEmail').value.trim();

    if (!isValidEmail(email)) {
      showMessage('forgotMessage', 'Please enter a valid email address');
      return;
    }

    const user = users[email];
    if (!user) {
      showMessage('forgotMessage', 'No account found with this email address');
      return;
    }

    // Generate reset code
    const resetCode = generateResetCode();
    resetCodes[email] = {
      code: resetCode,
      expires: Date.now() + 15 * 60 * 1000, // 15 minutes
      email: email
    };

    // Simulate sending email
    const emailSent = simulateEmailSend(email, resetCode);
    
    if (emailSent) {
      showMessage('forgotMessage', 
        `Reset code sent to ${email}! Check your email and use the code below. (For demo: ${resetCode})`, 
        'success'
      );
      
      setTimeout(() => {
        showResetPassword();
      }, 2000);
    } else {
      showMessage('forgotMessage', 'Failed to send reset email. Please try again.');
    }
  }

  async function resetPassword() {
    const resetCode = document.getElementById('resetCode').value.trim();
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (!resetCode) {
      showMessage('resetMessage', 'Please enter the reset code');
      return;
    }

    if (newPassword.length < 6) {
      showMessage('resetMessage', 'Password must be at least 6 characters long');
      return;
    }

    if (newPassword !== confirmPassword) {
      showMessage('resetMessage', 'Passwords do not match');
      return;
    }

    // Find matching reset code
    let validEmail = null;
    for (const email in resetCodes) {
      const resetData = resetCodes[email];
      if (resetData.code === resetCode && resetData.expires > Date.now()) {
        validEmail = email;
        break;
      }
    }

    if (!validEmail) {
      showMessage('resetMessage', 'Invalid or expired reset code');
      return;
    }

    // Hash new password and update user
    const hashedPassword = await hashPassword(newPassword);
    users[validEmail].password = hashedPassword;

    // Clean up reset code
    delete resetCodes[validEmail];

    showMessage('resetMessage', 'Password reset successful! Please login with your new password.', 'success');
    
    setTimeout(() => {
      showLogin();
      document.getElementById('loginEmail').value = validEmail;
      // Clear reset form
      document.getElementById('resetCode').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }, 2000);
  }

  async function signup() {
    const name = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;

    if (!name) {
      showMessage('signupMessage', 'Please enter your full name');
      return;
    }

    if (!isValidEmail(email)) {
      showMessage('signupMessage', 'Please enter a valid email address');
      return;
    }

    if (password.length < 6) {
      showMessage('signupMessage', 'Password must be at least 6 characters long');
      return;
    }

    if (users[email]) {
      showMessage('signupMessage', 'An account with this email already exists');
      return;
    }

    // Hash the password before storing
    const hashedPassword = await hashPassword(password);

    // Create new user with hashed password
    users[email] = {
      name: name,
      email: email,
      password: hashedPassword,
      createdAt: new Date().toISOString()
    };

    showMessage('signupMessage', 'Account created successfully! Please login.', 'success');
    
    setTimeout(() => {
      showLogin();
      document.getElementById('loginEmail').value = email;
    }, 1500);
  }

  async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!isValidEmail(email)) {
      showMessage('loginMessage', 'Please enter a valid email address');
      return;
    }

    if (!password) {
      showMessage('loginMessage', 'Please enter your password');
      return;
    }

    const user = users[email];
    if (!user) {
      showMessage('loginMessage', 'Invalid email or password');
      return;
    }

    // Verify password using hash comparison
    const isPasswordCorrect = await verifyPassword(password, user.password);
    if (!isPasswordCorrect) {
      showMessage('loginMessage', 'Invalid email or password');
      return;
    }

    // Generate consistent session ID for this user
    sessionId = await generateSessionId(email);
    console.log(`User ${email} session ID: ${sessionId}`);

    // Login successful
    currentUser = user;
    showInterviewOptions();
  }

  function logout() {
    currentUser = null;
    document.getElementById('authContainer').style.display = 'flex';
    document.getElementById('interviewOptions').style.display = 'none';
    document.getElementById('resumeContainer').style.display = 'none';
    document.getElementById('skillContainer').style.display = 'none';
    document.getElementById('interviewContainer').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('backBtn').style.display = 'none';
    
    // Reset interview state
    resetInterview();
    
    // Clear form fields
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    showLogin();
  }

  function showInterviewOptions() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('interviewOptions').style.display = 'flex';
    document.getElementById('logoutBtn').style.display = 'block';
  }

  function selectInterviewType(type) {
    interviewType = type;
    document.getElementById('interviewOptions').style.display = 'none';
    document.getElementById('backBtn').style.display = 'block';
    
    if (type === 'resume') {
      document.getElementById('resumeContainer').style.display = 'flex';
    } else if (type === 'skill') {
      document.getElementById('skillContainer').style.display = 'flex';
    }
  }

  function goBack() {
    // Determine current screen and go back appropriately
    const resumeContainer = document.getElementById('resumeContainer');
    const skillContainer = document.getElementById('skillContainer');
    const interviewContainer = document.getElementById('interviewContainer');
    
    // If we're in interview mode, go back to respective form
    if (interviewContainer.style.display === 'flex') {
      interviewContainer.style.display = 'none';
      
      // Reset interview state
      resetInterview();
      
      // Show the form based on interview type
      if (interviewType === 'resume') {
        document.getElementById('resumeContainer').style.display = 'flex';
      } else if (interviewType === 'skill') {
        document.getElementById('skillContainer').style.display = 'flex';
      }
      return;
    }
    
    // If we're in resume or skill form, go back to options
    if (resumeContainer.style.display === 'flex' || skillContainer.style.display === 'flex') {
      // Hide current containers
      resumeContainer.style.display = 'none';
      skillContainer.style.display = 'none';
      document.getElementById('backBtn').style.display = 'none';
      
      // Show interview options
      document.getElementById('interviewOptions').style.display = 'flex';
      
      // Reset any form data
      resetFormData();
      return;
    }
  }

  function resetFormData() {
    // Reset interview type and related data
    interviewType = '';
    skill = '';
    level = '';
    resumeFile = null;
    jobDescription = '';
    conversationHistory = [];
    
    // Clear file upload
    const fileInput = document.getElementById('resumeFile');
    if (fileInput) fileInput.value = '';
    const fileInfo = document.getElementById('fileInfo');
    if (fileInfo) fileInfo.style.display = 'none';
    
    // Clear job description
    const jdInput = document.getElementById('jobDescription');
    if (jdInput) jdInput.value = '';
    
    // Clear skill input
    const skillInput = document.getElementById('skillInput');
    if (skillInput) skillInput.value = '';
  }

  // File Upload Functions
  function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const validTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    if (!validTypes.includes(file.type)) {
      alert('Please upload a PDF, DOC, or DOCX file.');
      input.value = '';
      return;
    }

    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
      alert('File size must be less than 5MB.');
      input.value = '';
      return;
    }

    resumeFile = file;
    const fileInfo = document.getElementById('fileInfo');
    fileInfo.innerHTML = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    fileInfo.style.display = 'block';
  }

  function startResumeInterview() {
    if (!resumeFile) {
      alert('Please upload your resume first.');
      return;
    }

    jobDescription = document.getElementById('jobDescription').value.trim();
    
    // Hide resume container and show interview container
    document.getElementById('resumeContainer').style.display = 'none';
    document.getElementById('interviewContainer').style.display = 'flex';
    
    startResumeBasedInterview();
  }

  function proceedToSkillLevel() {
    const skillInput = document.getElementById('skillInput').value.trim();
    if (!skillInput) {
      alert('Please enter a skill.');
      return;
    }
    
    skill = skillInput;
    
    // Hide skill container and show interview container
    document.getElementById('skillContainer').style.display = 'none';
    document.getElementById('interviewContainer').style.display = 'flex';
    
    startSkillBasedInterview();
  }

  function resetInterview() {
    step = 0;
    interviewStartTime = null;
    interviewEnded = false;
    timerStarted = false;
    questionIndex = 0;
    totalQuestionsAsked = 0;
    conversationHistory = [];
    
    // Reset new tracking variables
    currentAIQuestion = null;
    questionId = 0;
    
    // Clear chat
    if (chat) chat.innerHTML = '';
    
    // Reset timer
    const timerElement = document.getElementById('timer');
    timerElement.style.display = 'none';
    timerElement.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
    
    // Reset question counter
    questionCounter.style.display = 'none';
    
    // Enable input
    if (input) {
      input.disabled = false;
      input.value = '';
      input.placeholder = "Type your answer...";
      input.classList.remove('disabled');
    }
    
    if (sendBtn) {
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
      sendBtn.classList.remove('disabled');
    }
  }

  // Interview Functions
  function addMessage(text, sender, isTimer = false, isDebug = false, isLoading = false) {
    const div = document.createElement('div');
    let className = 'message ' + sender;
    if (isTimer) className += ' timer-msg';
    if (isDebug) className += ' debug-info';
    if (isLoading) className += ' loading-msg';
    
    div.className = className;
    div.innerHTML = text.replace(/\n/g, '<br>');
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    
    return div; // Return the element so we can modify it later
  }

  function updateQuestionCounter() {
    if (timerStarted && questionIndex > 0) {
      questionCounter.style.display = 'block';
      currentQuestionSpan.textContent = questionIndex;
    }
  }

  function disableInput() {
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.textContent = "Ended";
    sendBtn.classList.add('disabled');
    input.classList.add('disabled');
    input.placeholder = "Interview completed";
  }

  function enableInput() {
    if (!interviewEnded) {
      input.disabled = false;
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send';
    }
  }

  function startInterviewTimer() {
    if (timerStarted) return;
    
    timerStarted = true;
    interviewStartTime = Date.now();
    
    addMessage("‚è±Ô∏è Your 3-minute interview starts now!", "ai", true);
    
    const timerElement = document.getElementById('timer');
    timerElement.style.display = 'block';
    
    const timerInterval = setInterval(() => {
      const remaining = getRemainingTime();
      const minutes = Math.floor(remaining / 60);
      const seconds = remaining % 60;
      timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      if (remaining === 30) {
        addMessage("‚ö†Ô∏è 30 seconds left!", "ai", true);
      }
      
      if (remaining <= 0) {
        clearInterval(timerInterval);
        endInterview();
      }
    }, 1000);
  }

  function endInterview() {
    if (interviewEnded) return;
    
    interviewEnded = true;
    addMessage("‚è∞ Time's up! Interview completed.", "ai", true);
    addMessage(`üìä Questions answered: ${totalQuestionsAsked}`, "ai");
    disableInput();
    
    const timerElement = document.getElementById('timer');
    timerElement.style.background = '#4a4a4a';
    timerElement.textContent = 'Done';
  }

  function getRemainingTime() {
    if (!interviewStartTime) return 180;
    const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
    return Math.max(0, 180 - elapsed);
  }

  // FIXED LOGGING FUNCTION - Logs question and response together
  async function logQuestionResponse(questionData, userResponse) {
    try {
      console.log('üìù Logging Q&A pair:', {
        sessionId: sessionId,
        questionId: questionData.id,
        questionText: questionData.text,
        userResponse: userResponse,
        timestamp: new Date().toISOString()
      });

      await fetch('https://interviewainumpy.app.n8n.cloud/webhook/log-interview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sessionId: sessionId,
          questionId: questionData.id,
          questionText: questionData.text,
          userResponse: userResponse,
          timestamp: new Date().toISOString(),
          questionTimestamp: questionData.timestamp
        })
      });
      console.log('‚úÖ Q&A logged successfully');
    } catch (error) {
      console.error('‚ùå Failed to log Q&A:', error);
    }
  }

  // FIXED AI INTERVIEWER FUNCTION - Better question tracking
async function callAIInterviewer(userMessage, isFirstMessage = false) {
  const loadingMessage = addMessage("AI is thinking...", "ai", false, false, true);
  
  // Add user message to conversation history if it exists
  if (userMessage && !isFirstMessage) {
    conversationHistory.push({
      role: "user",
      message: userMessage
    });
  }
  
  console.log('üì§ Sending to API:', {
    sessionId: sessionId,
    userMessage: userMessage,
    isFirstMessage: isFirstMessage,
    questionIndex: questionIndex
  });
  
  try {
    const response = await fetch('https://interviewainumpy.app.n8n.cloud/webhook/virtual-interview', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId: sessionId,
        name: currentUser.name,
        email: currentUser.email,
        skill: skill,
        level: level,
        jobDescription: jobDescription,
        userMessage: userMessage || "",
        questionIndex: questionIndex,
        totalQuestionsAsked: totalQuestionsAsked,
        conversationHistory: conversationHistory,
        interviewType: interviewType,
        step: isFirstMessage ? 'start_interview' : 'ongoing_interview',
        remainingTime: getRemainingTime(),
        password: currentUser.password || "default_password"
      }),
      timeout: 15000
    });

    // Remove loading message
    if (chat.contains(loadingMessage)) {
      chat.removeChild(loadingMessage);
    }

    if (response.ok) {
      const data = await response.json();
      console.log('üì• Received from API:', data);
      
      if (data?.reply?.trim()?.length > 0) {
        // Add AI response to conversation history
        conversationHistory.push({
          role: "assistant",
          message: data.reply
        });
        
        addMessage(data.reply, 'ai');
        questionIndex++;
        updateQuestionCounter();
        
        console.log('‚úÖ Question received and logged');
        return true;
      }
    }
    
    throw new Error('Invalid response from AI service');
    
  } catch (error) {
    console.error('‚ùå AI service error:', error);
    if (chat.contains(loadingMessage)) {
      chat.removeChild(loadingMessage);
    }
    
    return generateFallbackResponse(userMessage, isFirstMessage);
  }
}

  function generateFallbackResponse(userMessage, isFirstMessage) {
    let response;
    
    if (isFirstMessage) {
      if (interviewType === 'skill') {
        response = `Hello! I'll be conducting your ${skill} interview today. Let's start with a foundational question: Can you tell me about your experience with ${skill} and what projects you've worked on recently?`;
      } else {
        response = "Hello! I'll be conducting your interview today based on your resume. Let's start by having you walk me through your professional background and highlight some key achievements.";
      }
    } else {
      const genericResponses = [
        "That's interesting. Can you elaborate more on that approach?",
        "Good point. How would you handle edge cases or potential issues with that solution?",
        "I see. What other alternatives did you consider?",
        "That's a solid answer. Can you give me a specific example from your experience?",
        "Interesting perspective. How would you explain this concept to someone new to the field?",
        "Thank you for that explanation. What challenges have you faced while working with this?"
      ];
      
      response = genericResponses[Math.floor(Math.random() * genericResponses.length)];
    }
    
    // Store the fallback question the same way
    questionId++;
    const newQuestion = {
      id: questionId,
      text: response,
      timestamp: new Date().toISOString(),
      sessionId: sessionId
    };
    
    // Add AI response to conversation history
    conversationHistory.push({
      role: "assistant", 
      message: response
    });
    
    addMessage(response, 'ai');
    questionIndex++;
    updateQuestionCounter();
    
    // Set this as the question user needs to respond to
    currentAIQuestion = newQuestion;
    
    return true;
  }

  // FIXED SEND MESSAGE FUNCTION - Logs Q&A properly
async function sendMessage() {
  const message = input.value.trim();
  if (!message || interviewEnded) return;

  console.log('üë§ User response:', message);

  addMessage(message, 'user');
  input.value = '';
  input.disabled = true;
  sendBtn.disabled = true;
  sendBtn.textContent = '...';

  if (getRemainingTime() <= 0) {
    endInterview();
    return;
  }

  totalQuestionsAsked++;
  
  // Send user response and get next question
  await callAIInterviewer(message, false);
  
  enableInput();
}

  // Start Interview Functions
  async function startSkillBasedInterview() {
    document.getElementById('userInfo').innerHTML = `Interview Mode: Skill-based (${skill})`;
    
    // Ask for level selection
    addMessage(`Great! You've chosen ${skill} for your interview. Please select your experience level:`, 'ai');
    
    const levelButtons = `
      <div style="text-align: center; margin: 20px 0;">
        <button class="btn-level" onclick="selectLevel('Beginner')">Beginner</button>
        <button class="btn-level" onclick="selectLevel('Intermediate')">Intermediate</button>
        <button class="btn-level" onclick="selectLevel('Advanced')">Advanced</button>
      </div>
    `;
    
    const buttonDiv = document.createElement('div');
    buttonDiv.innerHTML = levelButtons;
    buttonDiv.className = 'message ai';
    chat.appendChild(buttonDiv);
    chat.scrollTop = chat.scrollHeight;
  }

  async function selectLevel(selectedLevel) {
    level = selectedLevel;
    
    // Remove level selection buttons
    const levelButtons = chat.querySelector('.btn-level').parentElement.parentElement;
    if (levelButtons) {
      chat.removeChild(levelButtons);
    }
    
    addMessage(`Selected level: ${level}`, 'user');
    addMessage(`Perfect! I'll tailor the interview questions for ${level} level ${skill}. Let me start the timer and begin with the first question.`, 'ai');
    
    startInterviewTimer();
    
    // Start the interview with AI
    await callAIInterviewer("", true); // First message - no user input yet
  }

  async function startResumeBasedInterview() {
    const jobDesc = jobDescription ? ' and job description' : '';
    document.getElementById('userInfo').innerHTML = `Interview Mode: Resume-based${jobDesc}`;
    
    addMessage("I'll analyze your resume and conduct an interview based on your experience and the role requirements.", 'ai');
    addMessage("Let me start the timer and begin with the first question.", 'ai');
    
    startInterviewTimer();
    
    // Start the interview with AI
    await callAIInterviewer("", true); // First message - no user input yet
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', function() {
    // Enter key support for inputs
    document.getElementById('loginPassword').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
    
    document.getElementById('signupPassword').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') signup();
    });
    
    document.getElementById('skillInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') proceedToSkillLevel();
    });
    
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    // Auto-resize textarea
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });
  });
</script>

</body>
</html>
